<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Film Rankings</title>
  <style>
    /* === CLASSIC MAC OS THEME === */
    @import url('https://fonts.googleapis.com/css2?family=Geneva:wght@400&family=VT323&display=swap');

    :root {
      --mac-platinum: #DDDDDD;
      --mac-window-bg: #EEEEEE;
      --mac-dark-border: #777777;
      --mac-darker-border: #555555;
      --mac-light-border: #FFFFFF;
      --mac-black: #000000;
      --mac-white: #FFFFFF;
      --mac-titlebar-stripe: #AAAAAA;
      --mac-highlight: #316AC5;
      --mac-highlight-text: #FFFFFF;
      --mac-field-bg: #FFFFFF;
      --mac-text: #000000;
      --mac-text-secondary: #555555;
      --mac-menu-highlight: #316AC5;
      --mac-desktop-bg: #5F7B97;
      --mac-font: 'Geneva', 'Charcoal', 'Chicago', 'Lucida Grande', 'Helvetica', sans-serif;
      --mac-font-pixel: 'VT323', 'Geneva', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--mac-font);
      font-size: 12px;
      color: var(--mac-text);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      cursor: default;
      -webkit-font-smoothing: none;
    }

    /* === DESKTOP === */
    #mac-desktop {
      width: 100vw;
      height: 100vh;
      background-color: var(--mac-desktop-bg);
      /* Classic Mac OS desktop pattern */
      background-image:
        radial-gradient(circle, rgba(0,0,0,0.08) 1px, transparent 1px);
      background-size: 4px 4px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* === MENU BAR === */
    #menu-bar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 2px solid var(--mac-black);
      display: none;
      align-items: center;
      padding: 0;
      font-size: 12px;
      font-weight: normal;
      color: var(--mac-text);
      z-index: 100;
      user-select: none;
      flex-shrink: 0;
    }

    .menu-item {
      padding: 1px 12px;
      height: 18px;
      display: flex;
      align-items: center;
      white-space: nowrap;
      cursor: default;
    }

    .menu-item:hover {
      background: var(--mac-menu-highlight);
      color: var(--mac-white);
    }

    .menu-apple {
      padding: 1px 10px;
      font-size: 14px;
    }

    .menu-app-name { font-weight: bold; }

    .menu-bar-spacer { flex: 1; }

    .menu-right {
      display: flex;
      align-items: center;
    }

    .menu-clock {
      font-variant-numeric: tabular-nums;
      font-size: 11px;
      padding-right: 8px;
    }

    /* === DESKTOP AREA === */
    #desktop-area {
      flex: 1;
      position: relative;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .desktop-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 72px;
      padding: 4px;
      cursor: default;
      user-select: none;
    }

    .desktop-icon-img {
      font-size: 36px;
      line-height: 1;
    }

    .desktop-icon-label {
      font-size: 10px;
      color: var(--mac-white);
      text-align: center;
      margin-top: 2px;
      word-break: break-word;
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
    }

    .desktop-icon-trash {
      margin-top: auto;
    }

    .desktop-icon.selected .desktop-icon-label {
      background: var(--mac-highlight);
      color: var(--mac-white);
    }

    /* === LOGIN SCREEN === */
    #login-screen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--mac-desktop-bg);
      background-image:
        radial-gradient(circle, rgba(0,0,0,0.08) 1px, transparent 1px);
      background-size: 4px 4px;
    }

    .login-dialog {
      background: var(--mac-platinum);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
      width: 340px;
      padding: 0;
    }

    .login-titlebar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 1px solid var(--mac-black);
      display: flex;
      align-items: center;
      padding: 0 6px;
      position: relative;
    }

    /* Classic Mac striped title bar */
    .login-titlebar::after {
      content: '';
      position: absolute;
      left: 28px;
      right: 28px;
      top: 3px;
      bottom: 3px;
      background: repeating-linear-gradient(
        0deg,
        var(--mac-white) 0px,
        var(--mac-white) 1px,
        var(--mac-titlebar-stripe) 1px,
        var(--mac-titlebar-stripe) 2px,
        var(--mac-white) 2px,
        var(--mac-white) 3px
      );
    }

    .login-titlebar-text {
      position: relative;
      z-index: 1;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      flex: 1;
      background: var(--mac-white);
      padding: 0 8px;
      display: inline;
      width: auto;
      margin: 0 auto;
    }

    .login-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .login-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .login-icon {
      font-size: 36px;
      flex-shrink: 0;
      line-height: 1;
    }

    .login-fields {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .login-fields label {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .login-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    #login-error {
      color: #CC0000;
      font-size: 11px;
      min-height: 14px;
      text-align: center;
    }

    /* === CLASSIC MAC BUTTONS === */
    .mac-btn {
      background: var(--mac-platinum);
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-dark-border) var(--mac-dark-border) var(--mac-light-border);
      border-radius: 4px;
      padding: 3px 16px;
      font-size: 12px;
      font-family: var(--mac-font);
      cursor: default;
      color: var(--mac-text);
      font-weight: normal;
      min-width: 60px;
      text-align: center;
    }

    .mac-btn:active {
      border-color: var(--mac-dark-border) var(--mac-light-border) var(--mac-light-border) var(--mac-dark-border);
      background: #CCCCCC;
    }

    .mac-btn-primary {
      border: 3px solid var(--mac-black);
      border-radius: 6px;
      padding: 2px 16px;
    }

    .mac-btn-sm {
      padding: 2px 10px;
      font-size: 11px;
      min-width: auto;
    }

    /* === CLASSIC MAC INPUT === */
    .mac-input {
      background: var(--mac-field-bg);
      color: var(--mac-text);
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 2px 4px;
      font-size: 12px;
      font-family: var(--mac-font);
      outline: none;
    }

    .mac-input:focus {
      outline: 1.5px solid var(--mac-highlight);
      outline-offset: 0;
    }

    /* === APP WINDOW === */
    #app {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 92%;
      max-width: 920px;
      max-height: calc(100vh - 20px - 80px);
      background: var(--mac-window-bg);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
      flex-direction: column;
      overflow: hidden;
      z-index: 50;
    }

    /* === WINDOW TITLEBAR (Classic Mac striped) === */
    .window-titlebar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 1px solid var(--mac-black);
      display: flex;
      align-items: center;
      padding: 0 6px;
      user-select: none;
      flex-shrink: 0;
      position: relative;
    }

    /* Horizontal stripes */
    .window-titlebar::after {
      content: '';
      position: absolute;
      left: 28px;
      right: 28px;
      top: 3px;
      bottom: 3px;
      background: repeating-linear-gradient(
        0deg,
        var(--mac-white) 0px,
        var(--mac-white) 1px,
        var(--mac-titlebar-stripe) 1px,
        var(--mac-titlebar-stripe) 2px,
        var(--mac-white) 2px,
        var(--mac-white) 3px
      );
      pointer-events: none;
    }

    .close-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--mac-black);
      background: var(--mac-white);
      cursor: default;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0;
      z-index: 1;
      position: relative;
    }

    .close-box:active {
      background: var(--mac-black);
    }

    .window-title {
      position: relative;
      z-index: 1;
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      color: var(--mac-text);
      background: var(--mac-white);
      padding: 0 8px;
      margin: 0 auto;
    }

    .zoom-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--mac-black);
      background: var(--mac-white);
      cursor: default;
      flex-shrink: 0;
      z-index: 1;
      position: relative;
    }

    /* Inner square for zoom box */
    .zoom-box::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 5px;
      height: 5px;
      border: 1px solid var(--mac-black);
    }

    /* === WINDOW TOOLBAR === */
    .window-toolbar {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-bottom: 1px solid var(--mac-dark-border);
      background: var(--mac-platinum);
      flex-shrink: 0;
    }

    .toolbar-spacer { flex: 1; }

    .toolbar-label {
      font-size: 11px;
      color: var(--mac-text-secondary);
    }

    .toolbar-divider {
      width: 1px;
      height: 16px;
      background: var(--mac-dark-border);
      margin: 0 4px;
    }

    /* === CLASSIC MAC TABS === */
    .mac-tabs {
      display: flex;
      gap: 0;
      padding: 0;
      background: var(--mac-platinum);
    }

    .mac-tab {
      background: var(--mac-platinum);
      border: 1px solid var(--mac-dark-border);
      border-bottom: 1px solid var(--mac-dark-border);
      padding: 3px 18px;
      font-size: 12px;
      font-family: var(--mac-font);
      cursor: default;
      color: var(--mac-text);
      font-weight: normal;
      border-radius: 4px 4px 0 0;
      margin-right: -1px;
      position: relative;
    }

    .mac-tab.active {
      background: var(--mac-window-bg);
      border-bottom-color: var(--mac-window-bg);
      font-weight: bold;
      z-index: 1;
    }

    .mac-tab:hover:not(.active) {
      background: #D5D5D5;
    }

    .tab-panel {
      border: 1px solid var(--mac-dark-border);
      border-top: none;
      padding: 10px;
      background: var(--mac-window-bg);
    }

    /* === WINDOW BODY === */
    .window-body {
      padding: 8px;
      flex: 1;
      overflow-y: auto;
      background: var(--mac-window-bg);
    }

    /* === STATS ROW === */
    .stats-row {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 80px;
      background: var(--mac-white);
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 4px 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--mac-text);
      font-family: var(--mac-font-pixel);
    }

    .stat-label {
      font-size: 10px;
      color: var(--mac-text-secondary);
    }

    /* === LEGEND (Rating Scale) === */
    .legend-box {
      border: 1px solid var(--mac-dark-border);
      padding: 8px 10px;
      margin-bottom: 10px;
      background: var(--mac-platinum);
    }

    .legend-title {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .scale-items { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .scale-item { display: flex; align-items: center; gap: 4px; font-size: 11px; }
    .scale-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.2); }
    .tag-items { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; font-size: 10px; color: var(--mac-text-secondary); }

    /* === SEARCH BAR === */
    .search-bar { display: flex; align-items: center; gap: 6px; margin: 8px 0; }
    .search-bar label { font-size: 12px; white-space: nowrap; }
    .search-bar .mac-input { flex: 1; }

    /* === CONTENT AREA (sunken list) === */
    .content-area {
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      background: var(--mac-field-bg);
      max-height: 460px;
      overflow-y: auto;
      min-height: 180px;
    }

    /* === YEAR & MONTH HEADERS === */
    .year-header {
      font-size: 12px;
      font-weight: bold;
      padding: 4px 8px;
      background: var(--mac-platinum);
      border-bottom: 1px solid var(--mac-dark-border);
      display: flex;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .year-count { font-weight: normal; color: var(--mac-text-secondary); }

    .month-header {
      font-size: 11px;
      font-weight: bold;
      padding: 3px 8px 3px 16px;
      background: #E8E8E8;
      color: var(--mac-text-secondary);
      border-bottom: 1px solid #DDD;
    }

    .month-count { font-weight: normal; color: #999; }

    /* === MOVIE ROW === */
    .movie-row {
      display: flex;
      align-items: center;
      padding: 3px 6px;
      gap: 8px;
      border-bottom: 1px solid #EEE;
      background: var(--mac-field-bg);
      cursor: default;
      min-height: 28px;
    }

    .movie-row:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .movie-row:hover .movie-date,
    .movie-row:hover .movie-info,
    .movie-row:hover .movie-rating { color: var(--mac-highlight-text); }

    .movie-poster {
      width: 30px;
      height: 44px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--mac-dark-border);
    }

    .movie-poster-ph {
      width: 30px;
      height: 44px;
      flex-shrink: 0;
      border: 1px solid var(--mac-dark-border);
      background: #EEE;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #AAA;
    }

    .movie-date {
      font-size: 11px;
      color: var(--mac-text-secondary);
      min-width: 62px;
      font-variant-numeric: tabular-nums;
    }

    .movie-title-wrap { flex: 1; min-width: 0; }

    .movie-title {
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-info {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-tags { display: flex; gap: 2px; flex-shrink: 0; }

    .tag {
      font-size: 8px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      padding: 1px 4px;
      font-weight: bold;
      border: 1px solid;
    }

    .tag-theater { background: #D0E0F0; color: #000080; border-color: #A0B0D0; }
    .tag-festival { background: #E0D0F0; color: #600080; border-color: #C0A0D0; }
    .tag-opening { background: #D0F0D0; color: #006000; border-color: #A0D0A0; }
    .tag-rewatch { background: #E0E0E0; color: #555; border-color: #C0C0C0; }

    .movie-rating {
      font-size: 13px;
      font-weight: bold;
      min-width: 34px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .rating-gold { color: #B8860B; }
    .rating-green { color: #006400; }
    .rating-orange { color: #CC7000; }
    .rating-red { color: #CC0000; }
    .rating-dnf { color: #808080; font-size: 10px; font-weight: normal; font-style: italic; }

    .movie-actions { display: flex; gap: 2px; margin-left: 4px; }

    /* === WATCHLIST === */
    .watch-item {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      gap: 8px;
      border-bottom: 1px solid #EEE;
      background: var(--mac-field-bg);
      cursor: default;
    }

    .watch-item:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .watch-num { font-size: 10px; color: #999; min-width: 22px; font-variant-numeric: tabular-nums; }
    .watch-title { flex: 1; font-size: 12px; }

    /* === FORMS === */
    .add-form {
      border: 1px solid var(--mac-dark-border);
      padding: 12px 10px 10px;
      margin: 10px 0;
      background: var(--mac-platinum);
      position: relative;
    }

    .add-form-label {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }

    .form-row { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; align-items: center; }
    .form-row label { font-size: 11px; white-space: nowrap; }
    .form-row .mac-input.date-input { width: 80px; }
    .form-row .mac-input.title-input { flex: 1; min-width: 140px; }
    .form-row .mac-input.rating-input { width: 55px; }
    .form-tags { display: flex; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
    .form-tags label { font-size: 11px; display: flex; align-items: center; gap: 3px; cursor: default; }

    /* TMDB Search Dropdown */
    .tmdb-dropdown {
      position: absolute;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--mac-field-bg);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
      max-height: 200px;
      overflow-y: auto;
    }

    .tmdb-result {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 6px;
      cursor: default;
      font-size: 11px;
    }

    .tmdb-result:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .tmdb-result img { width: 24px; height: 36px; object-fit: cover; border: 1px solid #CCC; }
    .tmdb-result-ph { width: 24px; height: 36px; background: #EEE; border: 1px solid #CCC; flex-shrink: 0; }

    /* Edit inline */
    .edit-inline {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 3px 6px;
      background: #FFFACC;
      border-bottom: 1px solid #DDD;
      flex-wrap: wrap;
    }

    .edit-inline .mac-input { font-size: 11px; }
    .edit-inline .mac-input.date-input { width: 72px; }
    .edit-inline .mac-input.title-input { flex: 1; min-width: 120px; }
    .edit-inline .mac-input.rating-input { width: 52px; }

    /* === STATUS BAR === */
    .window-statusbar {
      border-top: 1px solid var(--mac-dark-border);
      padding: 2px 8px;
      display: flex;
      gap: 4px;
      font-size: 10px;
      background: var(--mac-platinum);
      flex-shrink: 0;
      color: var(--mac-text-secondary);
    }

    .sb-section {
      border: 1px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 1px 6px;
      background: var(--mac-white);
    }

    .sb-section:first-child { flex: 2; }
    .sb-section:nth-child(2) { flex: 1; }
    .sb-section:last-child { flex: 1; text-align: right; }

    /* === EXPORT SECTION === */
    .export-section { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }

    /* === DOCK (Classic Mac Launcher Bar) === */
    #dock {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: var(--mac-platinum);
      border-top: 2px solid var(--mac-black);
      display: none;
      align-items: center;
      padding: 0 8px;
      z-index: 90;
      gap: 2px;
    }

    .dock-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid transparent;
      border-radius: 3px;
      cursor: default;
    }

    .dock-item:hover {
      border-color: var(--mac-dark-border);
      background: var(--mac-white);
    }

    .dock-item.dock-active {
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
      background: #D0D0D0;
    }

    .dock-icon { font-size: 20px; line-height: 1; }
    .dock-label { font-size: 11px; }

    .dock-divider {
      width: 1px;
      height: 28px;
      background: var(--mac-dark-border);
      margin: 0 6px;
    }

    .dock-spacer { flex: 1; }

    /* === CLASSIC MAC SCROLLBARS === */
    ::-webkit-scrollbar { width: 16px; height: 16px; }
    ::-webkit-scrollbar-track { background: var(--mac-platinum); border-left: 1px solid var(--mac-dark-border); }
    ::-webkit-scrollbar-thumb {
      background: var(--mac-platinum);
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
    }
    ::-webkit-scrollbar-thumb:active {
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
    }
    ::-webkit-scrollbar-button {
      background: var(--mac-platinum);
      border: 1px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
      height: 16px;
      width: 16px;
    }
    ::-webkit-scrollbar-button:active {
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
    }
    ::-webkit-scrollbar-corner { background: var(--mac-platinum); }

    /* === RESPONSIVE === */
    @media (max-width: 640px) {
      #menu-bar { font-size: 11px; }
      .menu-item:not(.menu-apple):not(.menu-app-name) { display: none; }
      .menu-right .menu-item:not(.menu-clock) { display: none; }

      #desktop-area { padding: 8px; }
      .desktop-icon { display: none; }

      #app {
        position: relative;
        top: auto;
        left: auto;
        transform: none;
        width: 100%;
        max-width: 100%;
        max-height: none;
        flex: 1;
        box-shadow: none;
        border-left: none;
        border-right: none;
      }

      #dock { display: none !important; }

      .movie-poster, .movie-poster-ph { width: 24px; height: 36px; }
      .movie-row { gap: 5px; padding: 2px 4px; }
      .stats-row { gap: 3px; }
      .stat-card { min-width: 60px; padding: 3px 4px; }
      .stat-value { font-size: 14px; }
      .content-area { max-height: 380px; }
      .window-toolbar { flex-wrap: wrap; gap: 4px; }
      .mac-tabs { flex-wrap: wrap; }
    }

    /* A bit more space on tiny screens */
    @media (max-width: 380px) {
      .movie-date { min-width: 50px; font-size: 10px; }
      .movie-rating { min-width: 28px; font-size: 12px; }
      .movie-poster, .movie-poster-ph { display: none; }
    }
  </style>
</head>
<body>

<div id="mac-desktop">

  <!-- Login Screen (Classic Mac dialog over desktop pattern) -->
  <div id="login-screen">
    <div class="login-dialog">
      <div class="login-titlebar">
        <span class="login-titlebar-text">Film Rankings</span>
      </div>
      <div class="login-body">
        <div class="login-row">
          <div class="login-icon">&#127916;</div>
          <div class="login-fields">
            <div style="font-size:12px;margin-bottom:4px">Enter password to access Film Rankings.</div>
            <label>
              Password:
              <input type="password" class="mac-input" id="pwd-input" style="flex:1;width:100%" autocomplete="off">
            </label>
          </div>
        </div>
        <p id="login-error"></p>
        <div class="login-buttons">
          <button class="mac-btn mac-btn-primary" onclick="attemptLogin()">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu Bar -->
  <div id="menu-bar">
    <div class="menu-item menu-apple">&#63743;</div>
    <div class="menu-item menu-app-name">Film Rankings</div>
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Help</div>
    <div class="menu-bar-spacer"></div>
    <div class="menu-right">
      <span class="menu-item" id="menu-mode-indicator"></span>
      <span class="menu-item menu-clock" id="menu-clock"></span>
    </div>
  </div>

  <!-- Desktop Area with Icons -->
  <div id="desktop-area">
    <div class="desktop-icon" ondblclick="focusAppWindow()">
      <div class="desktop-icon-img">&#127916;</div>
      <span class="desktop-icon-label">Film Rankings</span>
    </div>
    <div class="desktop-icon desktop-icon-trash">
      <div class="desktop-icon-img">&#128465;</div>
      <span class="desktop-icon-label">Trash</span>
    </div>
  </div>

  <!-- App Window -->
  <div id="app">
    <div class="window-titlebar">
      <div class="close-box" onclick="logout()" title="Close"></div>
      <span class="window-title" id="titlebar-text">Film Rankings</span>
      <div class="zoom-box" title="Zoom"></div>
    </div>

    <div class="window-toolbar" id="toolbar">
      <button class="mac-btn mac-btn-sm" onclick="switchTab('rankings')">Rankings</button>
      <button class="mac-btn mac-btn-sm" onclick="switchTab('watchlist')">Watchlist</button>
      <div class="toolbar-divider"></div>
      <span class="toolbar-label" id="toolbar-mode"></span>
      <div class="toolbar-spacer"></div>
      <button class="mac-btn mac-btn-sm" id="toolbar-export" style="display:none" onclick="exportData()">Export</button>
      <button class="mac-btn mac-btn-sm" onclick="logout()">Lock</button>
    </div>

    <div class="window-body">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="s-total">0</div><div class="stat-label">Rated</div></div>
        <div class="stat-card"><div class="stat-value" id="s-avg">0</div><div class="stat-label">Average</div></div>
        <div class="stat-card"><div class="stat-value" id="s-tens">0</div><div class="stat-label">Perfect 10s</div></div>
        <div class="stat-card"><div class="stat-value" id="s-watch">0</div><div class="stat-label">Watchlist</div></div>
      </div>

      <!-- Tabs -->
      <div class="mac-tabs">
        <button class="mac-tab active" data-tab="rankings" onclick="switchTab('rankings')">Rankings</button>
        <button class="mac-tab" data-tab="watchlist" onclick="switchTab('watchlist')">Watchlist</button>
      </div>

      <!-- Rankings Panel -->
      <div class="tab-panel" id="tab-rankings">
        <div class="legend-box">
          <div class="legend-title">Rating Scale</div>
          <div class="scale-items">
            <div class="scale-item"><span class="scale-dot" style="background:#B8860B"></span> 9+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#006400"></span> 7.5+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#CC7000"></span> 5+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#CC0000"></span> 0+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#808080"></span> DNF</div>
          </div>
          <div class="tag-items">
            <span><span class="tag tag-theater">T</span> Theater</span>
            <span><span class="tag tag-festival">F</span> Festival</span>
            <span><span class="tag tag-opening">OD</span> Opening Day</span>
            <span><span class="tag tag-rewatch">R</span> Rewatch</span>
          </div>
        </div>
        <div class="search-bar">
          <label for="filter-input">Find:</label>
          <input type="text" class="mac-input" id="filter-input" placeholder="Search movies..." oninput="render()">
        </div>
        <div class="content-area" id="ratings-list"></div>
        <div id="add-rating-section" style="position:relative"></div>
      </div>

      <!-- Watchlist Panel -->
      <div class="tab-panel" id="tab-watchlist" style="display:none">
        <div class="search-bar">
          <label for="filter-watch">Find:</label>
          <input type="text" class="mac-input" id="filter-watch" placeholder="Search watchlist..." oninput="render()">
        </div>
        <div class="content-area" id="watchlist-list"></div>
        <div id="add-watch-section" style="position:relative"></div>
      </div>

      <div id="export-section"></div>
    </div>

    <!-- Status Bar -->
    <div class="window-statusbar">
      <div class="sb-section" id="sb-mode">View Mode</div>
      <div class="sb-section" id="sb-count">0 films</div>
      <div class="sb-section" id="sb-tmdb">Ready</div>
    </div>
  </div>

  <!-- Dock / Launcher Bar -->
  <div id="dock">
    <div class="dock-item dock-active" title="Film Rankings" ondblclick="focusAppWindow()">
      <span class="dock-icon">&#127916;</span>
      <span class="dock-label">Film Rankings</span>
    </div>
    <div class="dock-divider"></div>
    <div class="dock-spacer"></div>
    <div class="dock-item" title="Trash">
      <span class="dock-icon">&#128465;</span>
      <span class="dock-label">Trash</span>
    </div>
  </div>

</div>

<script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script data-cfasync="false">
// === CONFIG ===
const VIEW_HASH = 'db944067d6c7762bee2cd7cc3c55e9f35ccea4e885fa17930856aefe784a1b52';
const EDIT_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918';
const SESSION_KEY = 'ac_films_mode';

// === SUPABASE CONFIG ===
const SUPABASE_URL = 'https://jubkcyjmzykndwlaobus.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1YmtjeWptenlrbmR3bGFvYnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTUzODAsImV4cCI6MjA4Njc3MTM4MH0.TZETJCf3fjBSWgXE4SviUuMh5j18rvv55QW5TYacO0I';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// === TMDB CONFIG ===
const TMDB_KEY = '696e0c182f4e0c9df706d94b7bf50021';
const TMDB_BASE = 'https://api.themoviedb.org/3';
const TMDB_IMG = 'https://image.tmdb.org/t/p';
const TMDB_CACHE_KEY = 'ac_films_tmdb';
const TMDB_GENRES = {
  28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',
  99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',
  27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Sci-Fi',
  10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'
};

// === DEFAULT DATA ===
const DEFAULT_RATINGS = [
  ["01/31/26","Fallen Angels",7.25,["f"]],
  ["01/30/26","The Incredibles",9.25,["f"]],
  ["01/29/26","Iron Lung",7.75,["o"]],
  ["01/12/26","Marty Supreme",9.75,["t"]],
  ["01/02/26","Wicked: For Good",5.75,["f"]],
  ["12/28/25","Brightburn",6,["f"]],
  ["12/26/25","Public Enemies",7.5,["f"]],
  ["12/26/25","Top Gun: Maverick",9.75,["r"]],
  ["12/20/25","Five Nights at Freddy's 2",6.5,["t"]],
  ["12/18/25","El Camino",7.25,["f"]],
  ["12/16/25","Identity",7.25,["f"]],
  ["12/14/25","The Island",6.25,["f"]],
  ["12/01/25","Frankenstein",7.5,["f"]],
  ["11/27/25","True Romance",8.5,["f"]],
  ["11/27/25","Everyone's Hero",7.5,["r"]],
  ["11/26/25","12 Monkeys",7.25,["f"]],
  ["11/24/25","Money Ball",9.25,["r"]],
  ["11/19/25","Free Solo",6.5,["f"]],
  ["11/15/25","Madagascar 3: Europe's Most Wanted",9.25,["r"]],
  ["11/10/25","Troy",6.5,["f"]],
  ["10/29/25","John Wick: Chapter 4",9.5,["f"]],
  ["10/15/25","Jennifer's Body",7.5,["f"]],
  ["09/27/25","One Battle After Another",8,["t"]],
  ["09/09/25","Tron: Legacy",8,["f"]],
  ["09/08/25","Call Me by Your Name",7.25,["f"]],
  ["08/20/25","The King",8.75,["r"]],
  ["07/31/25","John Wick: Chapter 3",8.75,["r"]],
  ["07/31/25","John Wick: Chapter 2",8.5,["r"]],
  ["07/29/25","Ick",8.25,["t"]],
  ["07/27/25","The Dark Knight",9.5,["r"]],
  ["07/16/25","Shark Tale",7,["r"]],
  ["07/01/25","Ballerina",8.5,["t"]],
  ["06/30/25","F1",9.25,["t"]],
  ["06/21/25","John Wick",9.25,["r"]],
  ["06/20/25","The Accountant 2","DNF",[]],
  ["06/13/25","The Girl Next Door",7.75,[]],
  ["05/27/25","Late Night with the Devil",6,[]],
  ["05/25/25","Tropic Thunder",9,["f"]],
  ["05/25/25","How to Train Your Dragon: The Hidden World",8.5,["f"]],
  ["05/24/25","How to Train Your Dragon 2",8.5,["r"]],
  ["05/24/25","How to Train Your Dragon",9.25,["r"]],
  ["05/24/25","Air Force Elite - Thunderbirds",6,["f"]],
  ["05/23/25","Mission: Impossible - Final Reckoning",9,["t"]],
  ["05/04/25","The Fighter",8.75,["t"]],
  ["05/02/25","Thunderbolts",8.25,["t"]],
  ["05/02/25","Anora",8.5,["f"]],
  ["05/01/25","The White House Effect",5.75,["f"]],
  ["04/29/25","OBEX",4.5,["f"]],
  ["04/29/25","The Kingdom",9,["t"]],
  ["04/28/25","Drive",8,["f"]],
  ["04/24/25","Warfare",8,["t"]],
  ["04/12/25","Goodfellas",8.75,["f"]],
  ["04/04/25","Minecraft",6.25,["t"]],
  ["03/26/25","Mickey 17",6,["t"]],
  ["03/23/25","Electric State",6,["f"]],
  ["02/26/25","The Monkey",5.75,["t"]],
  ["02/19/25","Companion",7.5,["t"]],
  ["02/05/25","Paul Blart: Mall Cop",7.25,["r"]],
  ["01/15/25","Better Man",8.5,["t"]],
  ["01/07/25","Wicked",8.5,["f"]],
  ["01/06/25","Boy Kills World",6,["f"]],
  ["01/03/25","Immaculate",6.5,["f"]],
  ["12/30/24","Gladiator 2",7.75,["f"]],
  ["12/28/24","Oddity",6.75,["f"]],
  ["12/27/24","Split",7.75,["r"]],
  ["12/27/24","Gladiator",8.75,["r"]],
  ["12/23/24","Transformers One",7.5,["r"]],
  ["12/16/24","Spy Game",6,["f"]],
  ["12/13/24","Subservience",6,["f"]],
  ["11/28/24","Oz",6.5,["f"]],
  ["11/27/24","Smile 2",7,["f"]],
  ["10/01/24","Wolfs",6.75,["f"]],
  ["09/13/24","The Disaster Artist",7,["f"]],
  ["05/30/24","Prom Dates",6.5,["f"]],
  ["05/20/24","Se7en",8.5,["f"]],
  ["05/18/24","Sicario",9,["f"]],
  ["05/05/24","Oldboy","DNF",[]],
  ["04/07/24","The Breath",8,["f"]],
  ["04/03/24","Imperium",8,["f"]],
  ["04/01/24","High Life",7.5,["f"]],
  ["03/02/24","Free Fire",7.5,["f"]],
  ["03/02/24","Mayhem","DNF",[]],
  ["03/01/24","Office Space",8,["f"]],
  ["02/29/24","Belko Experiment","DNF",[]],
  ["02/22/24","Dune: Part Two",10,["o"]],
  ["01/22/24","Kidnapping Inc",8.75,["o"]],
  ["01/21/24","A Different Man",8.75,["o"]],
  ["01/20/24","Love Lies Bleeding",8.25,["o"]],
  ["01/19/24","It's What's Inside",7.5,["o"]],
  ["01/19/24","Sasquatch Sunset",6,["o"]],
  ["01/14/24","Vivarium",6,["f"]],
  ["01/05/24","M.I.B",7.5,["r"]],
  ["01/05/24","R.I.P.D.",6,["f"]],
  ["01/04/24","The Creator",7.5,["f"]],
  ["12/25/23","The Other Guys",7.25,["f"]],
  ["12/24/23","The Lodge",6.5,["f"]],
  ["12/21/23","I'm Thinking of Ending Things",6,["f"]],
  ["12/20/23","The Hunger Games (2023)",7,["f"]],
  ["11/20/23","Hotel Transylvania: Transformania",5.75,["r"]],
  ["11/20/23","Hotel Transylvania 3",6.5,["r"]],
  ["11/20/23","Hotel Transylvania 2",7,["r"]],
  ["11/20/23","Hotel Transylvania",8.25,["r"]],
  ["10/05/23","Rejuvenation",3.5,["o"]],
  ["09/30/23","Better Luck Tomorrow",7.25,["f"]],
  ["09/17/23","Bottoms",8.25,["t"]],
  ["09/17/23","Ted",6.5,[]],
  ["09/07/23","The Speed Cubers",4.5,["f"]],
  ["09/05/23","The Big Short",8.25,["f"]],
  ["08/13/23","The Mist",5,["f"]],
  ["08/10/23","Sorry to Bother You",9,["f"]],
  ["08/10/23","La La Land",9,["f"]],
  ["08/10/23","The Nice Guys",6.5,["f"]],
  ["08/09/23","Gran Turismo",7.5,["o"]],
  ["07/21/23","Barbie",9,["o"]],
  ["07/21/23","Oppenheimer",9.5,["o"]],
  ["07/14/23","Butch Cassidy and the Sundance Kid",6.5,["f"]],
  ["07/10/23","Mission: Impossible - Dead Reckoning",9.5,["o"]],
  ["07/09/23","Ex Machina",9.5,["f"]],
  ["07/09/23","The Mask",8.75,["r"]],
  ["07/08/23","Journey 2: The Mysterious Island",3,["r"]],
  ["07/08/23","A Trip to the Moon",9.25,["f"]],
  ["07/06/23","Megamind",8.75,["r"]],
  ["07/05/23","Catch Me If You Can",8.5,["f"]],
  ["07/04/23","I, Tonya",8.5,["f"]],
  ["07/03/23","Focus",8.25,["f"]],
  ["07/02/23","2001: A Space Odyssey",7.5,["f"]],
  ["07/01/23","Amsterdam",5.75,["f"]],
  ["06/30/23","Harley Quinn: Birds of Prey",9,["t"]],
  ["06/30/23","Indiana Jones and the Dial of Destiny",7,["o"]],
  ["06/30/23","Suicide Squad",6,["f"]],
  ["06/29/23","Evil Dead Rise",4,["f"]],
  ["06/28/23","The Suicide Squad",5.25,["f"]],
  ["06/24/23","Spider-Man: Into the Spider-Verse",9.5,["f"]],
  ["06/23/23","Spider-Man: Across the Spider-Verse",9.75,["o"]],
  ["06/22/23","Asteroid City",8,["o"]],
  ["06/20/23","Black Panther: Wakanda Forever",5,["f"]],
  ["06/18/23","Inglorious Bastards",9,["r"]],
  ["06/17/23","Toy Story 2",8.75,["r"]],
  ["06/10/23","Fight Club",8.5,["f"]],
  ["06/09/23","Babylon",10,["f"]],
  ["06/06/23","Glass Onion: Knives Out",5.5,["f"]],
  ["06/04/23","Deadpool 2",7.75,["f"]],
  ["06/04/23","Deadpool",8.5,["f"]],
  ["06/03/23","Bullet Train",8.75,["r"]],
  ["06/03/23","Mario Movie",8.25,["f"]],
  ["05/27/23","American Psycho",9,["f"]],
  ["05/24/23","Once Upon a Time in Hollywood",7,["f"]],
  ["05/19/23","Blade Runner 2049",9.5,["r"]],
  ["05/17/23","Dune",9.75,["r"]],
  ["05/10/23","Pirates of the Caribbean 1",10,["f"]]
];

const DEFAULT_WATCHLIST = [
  "Fallen Angels","GOAT","Heretics","Sin City","Chronicle",
  "What Happened to Monday","Woman in Black","Guns Akimbo","Anthropoid",
  "True Detective","The Apprentice","Till Death","Run Lola Run",
  "Snatch","Rush","It Follows","LA Confidential","Mr. & Mrs. Smith",
  "Shaolin Soccer","The Aviator","Thelma & Louise","Pretty Woman",
  "3 Idiots","Taare Zameen Par","Apocalypse Now","Extraction","Chaplin",
  "The Revenant","Cleopatra (1963)","Secrets of the Octopus","The Gray Man",
  "Crazy, Stupid, Love","Beautiful Boy","Bombshell","Ad Astra",
  "Spring Breakers","Saturday Night","The Shining","Tron",
  "Judas and the Black Messiah","Psycho","Killer Joe"
];

// === STATE ===
let mode = null;
let ratings = [];
let watchlist = [];
let activeTab = 'rankings';
let editingId = null;
let tmdbCache = {};
let tmdbMatchRunning = false;
let seeding = false;

// === UTILITY ===
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function parseDate(d) {
  const [mm,dd,yy] = d.split('/').map(Number);
  return { month: mm, day: dd, year: 2000 + yy, sort: (2000+yy)*10000 + mm*100 + dd };
}

function computeSortOrder(dateStr) {
  const [mm,dd,yy] = dateStr.split('/').map(Number);
  return (2000+yy)*10000 + mm*100 + dd;
}

function ratingClass(r) {
  if (r === 'DNF') return 'rating-dnf';
  if (r >= 9) return 'rating-gold';
  if (r >= 7.5) return 'rating-green';
  if (r >= 5) return 'rating-orange';
  return 'rating-red';
}

function ratingDisplay(r) {
  if (r === 'DNF') return 'DNF';
  return Number.isInteger(r) ? r.toString() : r.toFixed(2).replace(/0$/, '');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// === AUTH ===
async function attemptLogin() {
  const pwd = document.getElementById('pwd-input').value;
  if (!pwd) return;
  const hash = await sha256(pwd);
  if (hash === EDIT_HASH) mode = 'edit';
  else if (hash === VIEW_HASH) mode = 'view';
  else {
    document.getElementById('login-error').textContent = 'Incorrect password.';
    document.getElementById('pwd-input').value = '';
    return;
  }
  sessionStorage.setItem(SESSION_KEY, mode);
  await showApp();
}

function logout() {
  mode = null;
  sessionStorage.removeItem(SESSION_KEY);
  document.getElementById('app').style.display = 'none';
  document.getElementById('menu-bar').style.display = 'none';
  document.getElementById('dock').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('pwd-input').value = '';
  document.getElementById('login-error').textContent = '';
}

async function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('menu-bar').style.display = 'flex';
  document.getElementById('dock').style.display = 'flex';
  document.getElementById('titlebar-text').textContent =
    'Film Rankings' + (mode === 'edit' ? ' - Edit Mode' : '');
  document.getElementById('toolbar-mode').textContent =
    mode === 'edit' ? 'Edit Mode' : 'View Mode';
  document.getElementById('toolbar-export').style.display =
    mode === 'edit' ? '' : 'none';
  document.getElementById('sb-mode').textContent =
    mode === 'edit' ? 'Edit Mode' : 'View Mode';
  document.getElementById('menu-mode-indicator').textContent =
    mode === 'edit' ? 'Edit' : 'View';
  await loadData();
  loadTMDBCache();
  render();
  autoMatchTMDB();
}

function focusAppWindow() {
  const app = document.getElementById('app');
  if (app) app.style.display = 'flex';
}

// === DATA ===
async function loadData() {
  const { data: dbRatings, error: ratErr } = await db
    .from('ratings')
    .select('*')
    .order('sort_order', { ascending: false });

  if (ratErr) {
    console.error('Failed to load ratings:', ratErr);
    return;
  }

  if (dbRatings && dbRatings.length > 0) {
    ratings = dbRatings.map(r => ({
      id: r.id,
      date: r.date,
      title: r.title,
      rating: r.rating === 'DNF' ? 'DNF' : parseFloat(r.rating),
      tags: r.tags || [],
      tmdb_id: r.tmdb_id
    }));
  } else if (!seeding) {
    await seedDefaults();
    return;
  }

  const { data: dbWatch, error: watchErr } = await db
    .from('watchlist')
    .select('*')
    .order('id', { ascending: true });

  if (watchErr) {
    console.error('Failed to load watchlist:', watchErr);
    return;
  }

  if (dbWatch && dbWatch.length > 0) {
    watchlist = dbWatch.map(w => ({ id: w.id, title: w.title }));
  }
}

async function seedDefaults() {
  seeding = true;
  const rows = DEFAULT_RATINGS.map(r => ({
    date: r[0],
    title: r[1],
    rating: String(r[2]),
    tags: r[3] || [],
    tmdb_id: r[4] || null,
    sort_order: computeSortOrder(r[0])
  }));
  await db.from('ratings').insert(rows);

  const watchRows = DEFAULT_WATCHLIST.map(t => ({ title: t }));
  await db.from('watchlist').insert(watchRows);

  seeding = false;
  await loadData();
}

// === TMDB ===
function loadTMDBCache() {
  try {
    const s = localStorage.getItem(TMDB_CACHE_KEY);
    if (s) tmdbCache = JSON.parse(s);
  } catch(e) { tmdbCache = {}; }
}

function saveTMDBCache() {
  localStorage.setItem(TMDB_CACHE_KEY, JSON.stringify(tmdbCache));
}

async function tmdbSearch(query, year) {
  let url = `${TMDB_BASE}/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}`;
  if (year) url += `&year=${year}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('TMDB ' + resp.status);
  return resp.json();
}

function tmdbCacheFromResult(r) {
  return {
    poster_path: r.poster_path,
    release_date: r.release_date || '',
    genres: (r.genre_ids || []).map(id => TMDB_GENRES[id]).filter(Boolean).slice(0, 3),
    ts: Date.now()
  };
}

function getPosterUrl(path, size) {
  if (!path) return null;
  return `${TMDB_IMG}/${size || 'w92'}${path}`;
}

function getTMDBInfo(tmdbId) {
  if (!tmdbId || !tmdbCache[tmdbId]) return null;
  return tmdbCache[tmdbId];
}

async function autoMatchTMDB() {
  if (tmdbMatchRunning) return;
  const unmatched = ratings.filter(r => !r.tmdb_id);
  if (unmatched.length === 0) {
    document.getElementById('sb-tmdb').textContent = 'TMDB: Ready';
    return;
  }
  tmdbMatchRunning = true;
  let matched = 0;
  const total = unmatched.length;

  for (let i = 0; i < unmatched.length; i += 5) {
    const batch = unmatched.slice(i, i + 5);
    const promises = batch.map(async movie => {
      try {
        let searchTitle = movie.title;
        let yearFilter = null;
        const ym = movie.title.match(/\((\d{4})\)$/);
        if (ym) {
          yearFilter = ym[1];
          searchTitle = movie.title.replace(/\s*\(\d{4}\)$/, '');
        }
        let data = await tmdbSearch(searchTitle, yearFilter);
        if ((!data.results || data.results.length === 0) && yearFilter) {
          data = await tmdbSearch(searchTitle, null);
        }
        if (data.results && data.results.length > 0) {
          const best = data.results[0];
          movie.tmdb_id = best.id;
          tmdbCache[best.id] = tmdbCacheFromResult(best);
          await db.from('ratings').update({ tmdb_id: best.id }).eq('id', movie.id);
          matched++;
        }
      } catch(e) { /* skip */ }
    });
    await Promise.all(promises);
    saveTMDBCache();
    document.getElementById('sb-tmdb').textContent =
      `TMDB: ${i + batch.length}/${total}`;
    render();
    await new Promise(r => setTimeout(r, 150));
  }
  document.getElementById('sb-tmdb').textContent = `TMDB: ${matched} matched`;
  tmdbMatchRunning = false;
}

// TMDB search for add form
let searchTimeout = null;
function onTitleSearch(val) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('tmdb-dropdown');
  if (!dd) return;
  if (val.length < 2) { dd.style.display = 'none'; return; }
  searchTimeout = setTimeout(async () => {
    try {
      const data = await tmdbSearch(val, null);
      if (!data.results || data.results.length === 0) {
        dd.style.display = 'none'; return;
      }
      let html = '';
      data.results.slice(0, 6).forEach(r => {
        const yr = r.release_date ? r.release_date.substring(0, 4) : '?';
        const poster = r.poster_path
          ? `<img src="${getPosterUrl(r.poster_path, 'w92')}" alt="">`
          : '<div class="tmdb-result-ph"></div>';
        html += `<div class="tmdb-result" data-id="${r.id}" data-title="${escHtml(r.title)}"
                  onclick="selectTMDBResult(this)">
          ${poster}<span>${escHtml(r.title)} (${yr})</span>
        </div>`;
      });
      dd.innerHTML = html;
      dd.style.display = 'block';
    } catch(e) { dd.style.display = 'none'; }
  }, 400);
}

function selectTMDBResult(el) {
  const id = parseInt(el.dataset.id);
  const title = el.dataset.title;
  document.getElementById('new-title').value = title;
  const hiddenId = document.getElementById('new-tmdb-id');
  if (hiddenId) hiddenId.value = id;
  const dd = document.getElementById('tmdb-dropdown');
  if (dd) dd.style.display = 'none';
  if (!tmdbCache[id]) {
    tmdbSearch(title, null).then(data => {
      if (data.results) {
        const match = data.results.find(r => r.id === id);
        if (match) { tmdbCache[id] = tmdbCacheFromResult(match); saveTMDBCache(); }
      }
    }).catch(() => {});
  }
}

// === RENDER ===
function render() {
  renderStats();
  if (activeTab === 'rankings') renderRatings();
  else renderWatchlist();
  renderEditSections();
  const numericCount = ratings.filter(r => r.rating !== 'DNF').length;
  document.getElementById('sb-count').textContent = numericCount + ' films rated';
}

function renderStats() {
  const nr = ratings.filter(r => r.rating !== 'DNF');
  const total = nr.length;
  const avg = total ? (nr.reduce((s,r) => s + r.rating, 0) / total).toFixed(2) : '0';
  const tens = nr.filter(r => r.rating === 10).length;
  document.getElementById('s-total').textContent = total;
  document.getElementById('s-avg').textContent = avg;
  document.getElementById('s-tens').textContent = tens;
  document.getElementById('s-watch').textContent = watchlist.length;
}

function renderRatings() {
  const filter = document.getElementById('filter-input').value.toLowerCase();
  const filtered = ratings.filter(r => r.title.toLowerCase().includes(filter));
  const years = {};
  filtered.forEach(r => {
    const p = parseDate(r.date);
    if (!years[p.year]) years[p.year] = {};
    if (!years[p.year][p.month]) years[p.year][p.month] = [];
    years[p.year][p.month].push(r);
  });

  let html = '';
  Object.keys(years).sort((a,b) => b - a).forEach(year => {
    const ym = Object.values(years[year]).flat();
    const yc = ym.filter(r => r.rating !== 'DNF').length;
    html += `<div class="year-header"><span>//${year}</span><span class="year-count">(${yc})</span></div>`;
    Object.keys(years[year]).sort((a,b) => b - a).forEach(month => {
      const movies = years[year][month];
      const mc = movies.filter(r => r.rating !== 'DNF').length;
      html += `<div class="month-header">${MONTHS[month-1]} <span class="month-count">(${mc})</span></div>`;
      movies.forEach(m => {
        html += editingId === m.id ? renderEditRow(m) : renderMovieRow(m);
      });
    });
  });
  document.getElementById('ratings-list').innerHTML = html;
}

function renderMovieRow(m) {
  const tags = (m.tags || []).map(t => {
    const cls = {t:'tag-theater',f:'tag-festival',o:'tag-opening',r:'tag-rewatch'}[t] || '';
    const label = {t:'T',f:'F',o:'OD',r:'R'}[t] || t;
    return `<span class="tag ${cls}">${label}</span>`;
  }).join('');

  const actions = mode === 'edit' ? `
    <div class="movie-actions">
      <button class="mac-btn mac-btn-sm" onclick="startEdit(${m.id})" title="Edit" style="min-width:auto;padding:1px 5px;font-size:10px">Edit</button>
      <button class="mac-btn mac-btn-sm" onclick="deleteRating(${m.id})" title="Delete" style="min-width:auto;padding:1px 5px;font-size:10px">&times;</button>
    </div>` : '';

  let posterHtml = '<div class="movie-poster-ph">?</div>';
  let infoHtml = '';
  const tmdb = getTMDBInfo(m.tmdb_id);
  if (tmdb) {
    if (tmdb.poster_path) {
      posterHtml = `<img class="movie-poster" src="${getPosterUrl(tmdb.poster_path)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
    }
    const yr = tmdb.release_date ? tmdb.release_date.substring(0, 4) : '';
    const genres = tmdb.genres ? tmdb.genres.join(', ') : '';
    const parts = [yr, genres].filter(Boolean);
    if (parts.length) infoHtml = `<div class="movie-info">${escHtml(parts.join(' \u00B7 '))}</div>`;
  }

  return `<div class="movie-row">
    ${posterHtml}
    <span class="movie-date">${escHtml(m.date)}</span>
    <div class="movie-title-wrap">
      <div class="movie-title">${escHtml(m.title)}</div>
      ${infoHtml}
    </div>
    <span class="movie-tags">${tags}</span>
    <span class="movie-rating ${ratingClass(m.rating)}">${ratingDisplay(m.rating)}</span>
    ${actions}
  </div>`;
}

function renderEditRow(m) {
  const tc = ['t','f','o','r'].map(t => {
    const l = {t:'Theater',f:'Festival',o:'Opening Day',r:'Rewatch'}[t];
    const ck = (m.tags || []).includes(t) ? 'checked' : '';
    return `<label><input type="checkbox" data-tag="${t}" ${ck}> ${l}</label>`;
  }).join('');

  return `<div class="edit-inline">
    <input class="mac-input date-input" id="edit-date" value="${escHtml(m.date)}">
    <input class="mac-input title-input" id="edit-title" value="${escHtml(m.title)}">
    <input class="mac-input rating-input" id="edit-rating" value="${m.rating === 'DNF' ? 'DNF' : m.rating}">
    <div class="form-tags">${tc}</div>
    <button class="mac-btn mac-btn-sm" onclick="saveEdit(${m.id})">Save</button>
    <button class="mac-btn mac-btn-sm" onclick="cancelEdit()">Cancel</button>
  </div>`;
}

function renderWatchlist() {
  const filter = document.getElementById('filter-watch').value.toLowerCase();
  const filtered = watchlist.filter(w => w.title.toLowerCase().includes(filter));
  let html = '';
  filtered.forEach((w, i) => {
    const actions = mode === 'edit' ? `
      <div class="movie-actions">
        <button class="mac-btn mac-btn-sm" onclick="watchedMovie(${w.id})" title="Mark watched" style="min-width:auto;padding:1px 5px;font-size:10px">Watched</button>
        <button class="mac-btn mac-btn-sm" onclick="deleteWatch(${w.id})" title="Remove" style="min-width:auto;padding:1px 5px;font-size:10px">&times;</button>
      </div>` : '';
    html += `<div class="watch-item">
      <span class="watch-num">${i + 1}.</span>
      <span class="watch-title">${escHtml(w.title)}</span>
      ${actions}
    </div>`;
  });
  document.getElementById('watchlist-list').innerHTML = html;
}

function renderEditSections() {
  const ars = document.getElementById('add-rating-section');
  const aws = document.getElementById('add-watch-section');
  const es = document.getElementById('export-section');

  if (mode !== 'edit') {
    if (ars) ars.innerHTML = '';
    if (aws) aws.innerHTML = '';
    if (es) es.innerHTML = '';
    return;
  }

  if (activeTab === 'rankings' && ars) {
    ars.innerHTML = `
      <div class="add-form">
        <span class="add-form-label">Add Movie</span>
        <div class="form-row">
          <label>Date:</label>
          <input class="mac-input date-input" id="new-date" placeholder="MM/DD/YY">
          <label>Title:</label>
          <input class="mac-input title-input" id="new-title" placeholder="Search TMDB..." oninput="onTitleSearch(this.value)">
          <label>Rating:</label>
          <input class="mac-input rating-input" id="new-rating" placeholder="0-10">
          <input type="hidden" id="new-tmdb-id">
        </div>
        <div id="tmdb-dropdown" class="tmdb-dropdown" style="display:none"></div>
        <div class="form-tags">
          <label><input type="checkbox" id="new-tag-t"> Theater</label>
          <label><input type="checkbox" id="new-tag-f"> Festival</label>
          <label><input type="checkbox" id="new-tag-o"> Opening Day</label>
          <label><input type="checkbox" id="new-tag-r"> Rewatch</label>
        </div>
        <button class="mac-btn" onclick="addRating()">Add</button>
      </div>`;
  } else if (activeTab === 'watchlist' && aws) {
    aws.innerHTML = `
      <div class="add-form">
        <span class="add-form-label">Add to Watchlist</span>
        <div class="form-row">
          <label>Title:</label>
          <input class="mac-input title-input" id="new-watch-title" placeholder="Movie title">
          <button class="mac-btn" onclick="addWatch()">Add</button>
        </div>
      </div>`;
  }

  if (es) {
    es.innerHTML = `
      <div class="export-section">
        <button class="mac-btn" onclick="exportData()">Export Data</button>
        <button class="mac-btn" onclick="resetData()">Reset to Defaults</button>
      </div>`;
  }
}

// === TAB SWITCHING ===
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.mac-tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('tab-rankings').style.display = tab === 'rankings' ? '' : 'none';
  document.getElementById('tab-watchlist').style.display = tab === 'watchlist' ? '' : 'none';
  editingId = null;
  render();
}

// === EDIT ACTIONS ===
async function addRating() {
  const date = document.getElementById('new-date').value.trim();
  const title = document.getElementById('new-title').value.trim();
  const rv = document.getElementById('new-rating').value.trim();
  const tmdbIdEl = document.getElementById('new-tmdb-id');
  const tmdbId = tmdbIdEl ? parseInt(tmdbIdEl.value) || null : null;
  if (!date || !title) return;

  const rating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  if (rating !== 'DNF' && isNaN(rating)) return;

  const tags = [];
  if (document.getElementById('new-tag-t').checked) tags.push('t');
  if (document.getElementById('new-tag-f').checked) tags.push('f');
  if (document.getElementById('new-tag-o').checked) tags.push('o');
  if (document.getElementById('new-tag-r').checked) tags.push('r');

  await db.from('ratings').insert({
    date,
    title,
    rating: String(rating),
    tags,
    tmdb_id: tmdbId,
    sort_order: computeSortOrder(date)
  });
  await loadData();
  render();

  document.getElementById('new-date').value = '';
  document.getElementById('new-title').value = '';
  document.getElementById('new-rating').value = '';
  if (tmdbIdEl) tmdbIdEl.value = '';
  ['new-tag-t','new-tag-f','new-tag-o','new-tag-r'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.checked = false;
  });
}

async function deleteRating(id) {
  await db.from('ratings').delete().eq('id', id);
  ratings = ratings.filter(r => r.id !== id);
  render();
}

function startEdit(id) { editingId = id; render(); }
function cancelEdit() { editingId = null; render(); }

async function saveEdit(id) {
  const m = ratings.find(r => r.id === id);
  if (!m) return;
  const newDate = document.getElementById('edit-date').value.trim();
  const newTitle = document.getElementById('edit-title').value.trim();
  const rv = document.getElementById('edit-rating').value.trim();
  const newRating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  const newTags = [];
  document.querySelectorAll('.edit-inline [data-tag]').forEach(cb => {
    if (cb.checked) newTags.push(cb.dataset.tag);
  });
  await db.from('ratings').update({
    date: newDate,
    title: newTitle,
    rating: String(newRating),
    tags: newTags,
    sort_order: computeSortOrder(newDate)
  }).eq('id', id);
  m.date = newDate;
  m.title = newTitle;
  m.rating = newRating;
  m.tags = newTags;
  editingId = null;
  render();
}

async function addWatch() {
  const title = document.getElementById('new-watch-title').value.trim();
  if (!title) return;
  await db.from('watchlist').insert({ title });
  await loadData();
  render();
  document.getElementById('new-watch-title').value = '';
}

async function deleteWatch(id) {
  await db.from('watchlist').delete().eq('id', id);
  watchlist = watchlist.filter(w => w.id !== id);
  render();
}

async function watchedMovie(id) {
  const w = watchlist.find(x => x.id === id);
  if (!w) return;
  const date = prompt('Date watched (MM/DD/YY):');
  if (!date) return;
  const rv = prompt('Rating (0-10 or DNF):');
  if (rv === null) return;
  const rating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  if (rating !== 'DNF' && isNaN(rating)) return;

  await db.from('watchlist').delete().eq('id', id);
  await db.from('ratings').insert({
    date,
    title: w.title,
    rating: String(rating),
    tags: [],
    tmdb_id: null,
    sort_order: computeSortOrder(date)
  });
  await loadData();
  render();
}

// === EXPORT / RESET ===
function exportData() {
  const data = JSON.stringify({ ratings, watchlist }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'films_data.json'; a.click();
  URL.revokeObjectURL(url);
}

async function resetData() {
  if (!confirm('Reset all data to defaults? This will erase any edits and TMDB cache.')) return;
  await db.from('ratings').delete().gt('id', 0);
  await db.from('watchlist').delete().gt('id', 0);
  localStorage.removeItem(TMDB_CACHE_KEY);
  tmdbCache = {};
  await seedDefaults();
  render();
  autoMatchTMDB();
}

// === MENU BAR CLOCK ===
function updateClock() {
  const now = new Date();
  const el = document.getElementById('menu-clock');
  if (el) {
    el.textContent = now.toLocaleTimeString('en-US', {
      hour: 'numeric', minute: '2-digit', hour12: true
    });
  }
}
updateClock();
setInterval(updateClock, 30000);

// === INIT ===
document.getElementById('pwd-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') attemptLogin();
});

const savedMode = sessionStorage.getItem(SESSION_KEY);
if (savedMode === 'view' || savedMode === 'edit') {
  mode = savedMode;
  showApp();
}
</script>

</body>
</html>
