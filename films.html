<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Film Rankings</title>
  <style>
    /* === CLASSIC MAC OS THEME === */
    @import url('https://fonts.googleapis.com/css2?family=Geneva:wght@400&family=VT323&display=swap');

    :root {
      --mac-platinum: #DDDDDD;
      --mac-window-bg: #EEEEEE;
      --mac-dark-border: #777777;
      --mac-darker-border: #555555;
      --mac-light-border: #FFFFFF;
      --mac-black: #000000;
      --mac-white: #FFFFFF;
      --mac-titlebar-stripe: #AAAAAA;
      --mac-highlight: #316AC5;
      --mac-highlight-text: #FFFFFF;
      --mac-field-bg: #FFFFFF;
      --mac-text: #000000;
      --mac-text-secondary: #555555;
      --mac-menu-highlight: #316AC5;
      --mac-desktop-bg: #5F7B97;
      --mac-font: 'Geneva', 'Charcoal', 'Chicago', 'Lucida Grande', 'Helvetica', sans-serif;
      --mac-font-pixel: 'VT323', 'Geneva', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--mac-font);
      font-size: 12px;
      color: var(--mac-text);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      cursor: default;
      -webkit-font-smoothing: none;
    }

    /* === DESKTOP === */
    #mac-desktop {
      width: 100vw;
      height: 100vh;
      background-color: var(--mac-desktop-bg);
      /* Classic Mac OS desktop pattern */
      background-image:
        radial-gradient(circle, rgba(0,0,0,0.08) 1px, transparent 1px);
      background-size: 4px 4px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* === MENU BAR === */
    #menu-bar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 2px solid var(--mac-black);
      display: none;
      align-items: center;
      padding: 0;
      font-size: 12px;
      font-weight: normal;
      color: var(--mac-text);
      z-index: 100;
      user-select: none;
      flex-shrink: 0;
    }

    .menu-item {
      padding: 1px 12px;
      height: 18px;
      display: flex;
      align-items: center;
      white-space: nowrap;
      cursor: default;
    }

    .menu-item:hover {
      background: var(--mac-menu-highlight);
      color: var(--mac-white);
    }

    .menu-app-name { font-weight: bold; }

    .menu-bar-spacer { flex: 1; }

    .menu-right {
      display: flex;
      align-items: center;
    }

    .menu-clock {
      font-variant-numeric: tabular-nums;
      font-size: 11px;
      padding-right: 8px;
    }

    /* === DESKTOP AREA === */
    #desktop-area {
      flex: 1;
      position: relative;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .desktop-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 72px;
      padding: 4px;
      cursor: default;
      user-select: none;
    }

    .desktop-icon-img {
      font-size: 36px;
      line-height: 1;
    }

    .desktop-icon-label {
      font-size: 10px;
      color: var(--mac-white);
      text-align: center;
      margin-top: 2px;
      word-break: break-word;
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
    }

    .desktop-icon.selected .desktop-icon-label {
      background: var(--mac-highlight);
      color: var(--mac-white);
    }

    /* === LOGIN SCREEN === */
    #login-screen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--mac-desktop-bg);
      background-image:
        radial-gradient(circle, rgba(0,0,0,0.08) 1px, transparent 1px);
      background-size: 4px 4px;
    }

    .login-dialog {
      background: var(--mac-platinum);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
      width: 340px;
      padding: 0;
    }

    .login-titlebar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 1px solid var(--mac-black);
      display: flex;
      align-items: center;
      padding: 0 6px;
      position: relative;
    }

    /* Classic Mac striped title bar */
    .login-titlebar::after {
      content: '';
      position: absolute;
      left: 28px;
      right: 28px;
      top: 3px;
      bottom: 3px;
      background: repeating-linear-gradient(
        0deg,
        var(--mac-white) 0px,
        var(--mac-white) 1px,
        var(--mac-titlebar-stripe) 1px,
        var(--mac-titlebar-stripe) 2px,
        var(--mac-white) 2px,
        var(--mac-white) 3px
      );
    }

    .login-titlebar-text {
      position: relative;
      z-index: 1;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      flex: 1;
      background: var(--mac-white);
      padding: 0 8px;
      display: inline;
      width: auto;
      margin: 0 auto;
    }

    .login-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .login-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .login-icon {
      font-size: 36px;
      flex-shrink: 0;
      line-height: 1;
    }

    .login-fields {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .login-fields label {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .login-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    #login-error {
      color: #CC0000;
      font-size: 11px;
      min-height: 14px;
      text-align: center;
    }

    /* === CLASSIC MAC BUTTONS === */
    .mac-btn {
      background: var(--mac-platinum);
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-dark-border) var(--mac-dark-border) var(--mac-light-border);
      border-radius: 4px;
      padding: 3px 16px;
      font-size: 12px;
      font-family: var(--mac-font);
      cursor: default;
      color: var(--mac-text);
      font-weight: normal;
      min-width: 60px;
      text-align: center;
    }

    .mac-btn:active {
      border-color: var(--mac-dark-border) var(--mac-light-border) var(--mac-light-border) var(--mac-dark-border);
      background: #CCCCCC;
    }

    .mac-btn-primary {
      border: 3px solid var(--mac-black);
      border-radius: 6px;
      padding: 2px 16px;
    }

    .mac-btn-sm {
      padding: 2px 10px;
      font-size: 11px;
      min-width: auto;
    }

    /* === CLASSIC MAC INPUT === */
    .mac-input {
      background: var(--mac-field-bg);
      color: var(--mac-text);
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 2px 4px;
      font-size: 12px;
      font-family: var(--mac-font);
      outline: none;
    }

    .mac-input:focus {
      outline: 1.5px solid var(--mac-highlight);
      outline-offset: 0;
    }

    /* === APP WINDOW === */
    #app {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 92%;
      max-width: 920px;
      max-height: calc(100vh - 20px - 80px);
      background: var(--mac-window-bg);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
      flex-direction: column;
      overflow: hidden;
      z-index: 50;
    }

    /* === WINDOW TITLEBAR (Classic Mac striped) === */
    .window-titlebar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 1px solid var(--mac-black);
      display: flex;
      align-items: center;
      padding: 0 6px;
      user-select: none;
      flex-shrink: 0;
      position: relative;
      cursor: grab;
    }

    /* Horizontal stripes */
    .window-titlebar::after {
      content: '';
      position: absolute;
      left: 28px;
      right: 28px;
      top: 3px;
      bottom: 3px;
      background: repeating-linear-gradient(
        0deg,
        var(--mac-white) 0px,
        var(--mac-white) 1px,
        var(--mac-titlebar-stripe) 1px,
        var(--mac-titlebar-stripe) 2px,
        var(--mac-white) 2px,
        var(--mac-white) 3px
      );
      pointer-events: none;
    }

    .close-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--mac-black);
      background: var(--mac-white);
      cursor: default;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0;
      z-index: 1;
      position: relative;
    }

    .close-box:active {
      background: var(--mac-black);
    }

    .window-title {
      position: relative;
      z-index: 1;
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      color: var(--mac-text);
      background: var(--mac-white);
      padding: 0 8px;
      margin: 0 auto;
    }

    .zoom-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--mac-black);
      background: var(--mac-white);
      cursor: default;
      flex-shrink: 0;
      z-index: 1;
      position: relative;
    }

    /* Inner square for zoom box */
    .zoom-box::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 5px;
      height: 5px;
      border: 1px solid var(--mac-black);
    }

    /* === WINDOW TOOLBAR === */
    .window-toolbar {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-bottom: 1px solid var(--mac-dark-border);
      background: var(--mac-platinum);
      flex-shrink: 0;
    }

    .toolbar-spacer { flex: 1; }

    .toolbar-label {
      font-size: 11px;
      color: var(--mac-text-secondary);
    }

    .toolbar-divider {
      width: 1px;
      height: 16px;
      background: var(--mac-dark-border);
      margin: 0 4px;
    }

    /* === CLASSIC MAC TABS === */
    .mac-tabs {
      display: flex;
      gap: 0;
      padding: 0;
      background: var(--mac-platinum);
    }

    .mac-tab {
      background: var(--mac-platinum);
      border: 1px solid var(--mac-dark-border);
      border-bottom: 1px solid var(--mac-dark-border);
      padding: 3px 18px;
      font-size: 12px;
      font-family: var(--mac-font);
      cursor: default;
      color: var(--mac-text);
      font-weight: normal;
      border-radius: 4px 4px 0 0;
      margin-right: -1px;
      position: relative;
    }

    .mac-tab.active {
      background: var(--mac-window-bg);
      border-bottom-color: var(--mac-window-bg);
      font-weight: bold;
      z-index: 1;
    }

    .mac-tab:hover:not(.active) {
      background: #D5D5D5;
    }

    .tab-panel {
      border: 1px solid var(--mac-dark-border);
      border-top: none;
      padding: 10px;
      background: var(--mac-window-bg);
    }

    /* === WINDOW BODY === */
    .window-body {
      padding: 8px;
      flex: 1;
      overflow-y: auto;
      background: var(--mac-window-bg);
    }

    /* === STATS ROW === */
    .stats-row {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 80px;
      background: var(--mac-white);
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 4px 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--mac-text);
      font-family: var(--mac-font-pixel);
    }

    .stat-label {
      font-size: 10px;
      color: var(--mac-text-secondary);
    }

    /* === LEGEND (Rating Scale) === */
    .legend-box {
      border: 1px solid var(--mac-dark-border);
      padding: 8px 10px;
      margin-bottom: 10px;
      background: var(--mac-platinum);
    }

    .legend-title {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .scale-items { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .scale-item { display: flex; align-items: center; gap: 4px; font-size: 11px; }
    .scale-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.2); }
    .tag-items { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; font-size: 10px; color: var(--mac-text-secondary); }

    /* === SEARCH BAR === */
    .search-bar { display: flex; align-items: center; gap: 6px; margin: 8px 0; }
    .search-bar label { font-size: 12px; white-space: nowrap; }
    .search-bar .mac-input { flex: 1; }

    /* === CONTENT AREA (sunken list) === */
    .content-area {
      border: 2px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      background: var(--mac-field-bg);
      max-height: 460px;
      overflow-y: auto;
      min-height: 180px;
    }

    /* === YEAR & MONTH HEADERS === */
    .year-header {
      font-size: 12px;
      font-weight: bold;
      padding: 4px 8px;
      background: var(--mac-platinum);
      border-bottom: 1px solid var(--mac-dark-border);
      display: flex;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .year-count { font-weight: normal; color: var(--mac-text-secondary); }

    .month-header {
      font-size: 11px;
      font-weight: bold;
      padding: 3px 8px 3px 16px;
      background: #E8E8E8;
      color: var(--mac-text-secondary);
      border-bottom: 1px solid #DDD;
    }

    .month-count { font-weight: normal; color: #999; }

    /* === MOVIE ROW === */
    .movie-row {
      display: flex;
      align-items: center;
      padding: 3px 6px;
      gap: 8px;
      border-bottom: 1px solid #EEE;
      background: var(--mac-field-bg);
      cursor: default;
      min-height: 28px;
    }

    .movie-row:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .movie-row:hover .movie-date,
    .movie-row:hover .movie-info,
    .movie-row:hover .movie-rating { color: var(--mac-highlight-text); }

    .movie-poster {
      width: 30px;
      height: 44px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--mac-dark-border);
    }

    .movie-poster-ph {
      width: 30px;
      height: 44px;
      flex-shrink: 0;
      border: 1px solid var(--mac-dark-border);
      background: #EEE;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #AAA;
    }

    .movie-date {
      font-size: 11px;
      color: var(--mac-text-secondary);
      min-width: 62px;
      font-variant-numeric: tabular-nums;
    }

    .movie-title-wrap { flex: 1; min-width: 0; }

    .movie-title {
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-info {
      font-size: 10px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-tags { display: flex; gap: 2px; flex-shrink: 0; }

    .tag {
      font-size: 8px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      padding: 1px 4px;
      font-weight: bold;
      border: 1px solid;
    }

    .tag-theater { background: #D0E0F0; color: #000080; border-color: #A0B0D0; }
    .tag-festival { background: #E0D0F0; color: #600080; border-color: #C0A0D0; }
    .tag-opening { background: #D0F0D0; color: #006000; border-color: #A0D0A0; }
    .tag-prelist { background: #E0E0E0; color: #555; border-color: #C0C0C0; }

    .movie-rating {
      font-size: 13px;
      font-weight: bold;
      min-width: 34px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .rating-gold { color: #DAA520; }
    .rating-green { color: #2E8B57; }
    .rating-orange { color: #E88B00; }
    .rating-red { color: #E02020; }
    .rating-dnf { color: #808080; font-size: 10px; font-weight: normal; font-style: italic; }

    .adjusted-score {
      display: block;
      font-size: 9px;
      font-weight: normal;
      color: #888;
      text-align: right;
    }

    .movie-actions { display: flex; gap: 2px; margin-left: 4px; }

    .rewatch-badge {
      font-size: 9px;
      font-weight: bold;
      color: #666;
      background: #E8E8E8;
      border: 1px solid #CCC;
      border-radius: 3px;
      padding: 0 3px;
      margin-left: 4px;
      vertical-align: middle;
    }

    /* === WATCHLIST === */
    .watch-item {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      gap: 8px;
      border-bottom: 1px solid #EEE;
      background: var(--mac-field-bg);
      cursor: default;
    }

    .watch-item:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .watch-num { font-size: 10px; color: #999; min-width: 22px; font-variant-numeric: tabular-nums; }
    .watch-title { font-size: 12px; }

    /* === FORMS === */
    .add-form {
      border: 1px solid var(--mac-dark-border);
      padding: 12px 10px 10px;
      margin: 10px 0;
      background: var(--mac-platinum);
      position: relative;
    }

    .add-form-label {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }

    .form-row { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; align-items: center; }
    .form-row label { font-size: 11px; white-space: nowrap; }
    .form-row .mac-input.date-input { width: 80px; }
    .form-row .mac-input.title-input { flex: 1; min-width: 140px; }
    .form-row .mac-input.rating-input { width: 55px; }
    .form-tags { display: flex; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
    .form-tags label { font-size: 11px; display: flex; align-items: center; gap: 3px; cursor: default; }

    /* TMDB Search Dropdown */
    .tmdb-dropdown {
      position: absolute;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--mac-field-bg);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
      max-height: 200px;
      overflow-y: auto;
    }

    .tmdb-result {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 6px;
      cursor: default;
      font-size: 11px;
    }

    .tmdb-result:hover {
      background: var(--mac-highlight);
      color: var(--mac-highlight-text);
    }

    .tmdb-result img { width: 24px; height: 36px; object-fit: cover; border: 1px solid #CCC; }
    .tmdb-result-ph { width: 24px; height: 36px; background: #EEE; border: 1px solid #CCC; flex-shrink: 0; }

    /* Edit inline */
    .edit-inline {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 3px 6px;
      background: #FFFACC;
      border-bottom: 1px solid #DDD;
      flex-wrap: wrap;
    }

    .edit-inline .mac-input { font-size: 11px; }
    .edit-inline .mac-input.date-input { width: 72px; }
    .edit-inline .mac-input.title-input { flex: 1; min-width: 120px; }
    .edit-inline .mac-input.rating-input { width: 52px; }

    /* Undo bar */
    .undo-bar {
      background: #FFFACC;
      border: 1px solid var(--mac-dark-border);
      padding: 4px 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }

    /* Movie detail modal */
    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-dialog {
      background: var(--mac-platinum);
      border: 2px solid var(--mac-black);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
      width: 480px;
      max-width: 94vw;
      max-height: 80vh;
      overflow-y: auto;
    }

    .detail-titlebar {
      height: 20px;
      background: var(--mac-white);
      border-bottom: 1px solid var(--mac-black);
      display: flex;
      align-items: center;
      padding: 0 6px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .detail-titlebar::after {
      content: '';
      position: absolute;
      left: 28px;
      right: 28px;
      top: 3px;
      bottom: 3px;
      background: repeating-linear-gradient(
        0deg,
        var(--mac-white) 0px,
        var(--mac-white) 1px,
        var(--mac-titlebar-stripe) 1px,
        var(--mac-titlebar-stripe) 2px,
        var(--mac-white) 2px,
        var(--mac-white) 3px
      );
      pointer-events: none;
    }

    .detail-titlebar .close-box { z-index: 1; }

    .detail-titlebar-text {
      position: relative;
      z-index: 1;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      flex: 1;
      background: var(--mac-white);
      padding: 0 8px;
    }

    .detail-body {
      padding: 14px;
      display: flex;
      gap: 14px;
    }

    .detail-poster { width: 154px; flex-shrink: 0; }
    .detail-poster img { width: 100%; border: 1px solid var(--mac-dark-border); }

    .detail-info { flex: 1; min-width: 0; }
    .detail-info h2 { font-size: 14px; margin-bottom: 4px; }

    .detail-meta {
      font-size: 11px;
      color: var(--mac-text-secondary);
      margin-bottom: 8px;
    }

    .detail-section { margin-bottom: 8px; }

    .detail-section-title {
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      color: var(--mac-text-secondary);
      margin-bottom: 2px;
    }

    .detail-section-content { font-size: 11px; }

    .provider-logos {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .provider-logo {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      border: 1px solid var(--mac-dark-border);
    }

    /* Watch providers on watchlist */
    .watch-title-wrap { flex: 1; min-width: 0; }

    .watch-providers {
      font-size: 10px;
      color: var(--mac-text-secondary);
      display: flex;
      align-items: center;
      gap: 3px;
      flex-wrap: wrap;
      margin-top: 1px;
    }

    .watch-provider-logo {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #CCC;
    }

    .watch-item:hover .watch-providers { color: var(--mac-highlight-text); }

    .watch-provider-group {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      margin-right: 6px;
    }

    .watch-provider-label {
      font-size: 9px;
      font-weight: bold;
      text-transform: uppercase;
      margin-right: 2px;
    }

    .watch-provider-name { font-size: 9px; }

    .watch-suggested {
      font-size: 9px;
      color: #888;
      font-style: italic;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === STATUS BAR === */
    .window-statusbar {
      border-top: 1px solid var(--mac-dark-border);
      padding: 2px 8px;
      display: flex;
      gap: 4px;
      font-size: 10px;
      background: var(--mac-platinum);
      flex-shrink: 0;
      color: var(--mac-text-secondary);
    }

    .sb-section {
      border: 1px solid;
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
      padding: 1px 6px;
      background: var(--mac-white);
    }

    .sb-section:first-child { flex: 2; }
    .sb-section:nth-child(2) { flex: 1; }
    .sb-section:last-child { flex: 1; text-align: right; }

    /* === EXPORT SECTION === */
    .export-section { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }

    /* === DOCK (Classic Mac Launcher Bar) === */
    #dock {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: var(--mac-platinum);
      border-top: 2px solid var(--mac-black);
      display: none;
      align-items: center;
      padding: 0 8px;
      z-index: 90;
      gap: 2px;
    }

    .dock-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid transparent;
      border-radius: 3px;
      cursor: default;
    }

    .dock-item:hover {
      border-color: var(--mac-dark-border);
      background: var(--mac-white);
    }

    .dock-item.dock-active {
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
      background: #D0D0D0;
    }

    .dock-icon { font-size: 20px; line-height: 1; }
    .dock-label { font-size: 11px; }

    .dock-divider {
      width: 1px;
      height: 28px;
      background: var(--mac-dark-border);
      margin: 0 6px;
    }

    .dock-spacer { flex: 1; }

    /* === CLASSIC MAC SCROLLBARS === */
    ::-webkit-scrollbar { width: 16px; height: 16px; }
    ::-webkit-scrollbar-track { background: var(--mac-platinum); border-left: 1px solid var(--mac-dark-border); }
    ::-webkit-scrollbar-thumb {
      background: var(--mac-platinum);
      border: 2px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
    }
    ::-webkit-scrollbar-thumb:active {
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
    }
    ::-webkit-scrollbar-button {
      background: var(--mac-platinum);
      border: 1px solid;
      border-color: var(--mac-light-border) var(--mac-darker-border) var(--mac-darker-border) var(--mac-light-border);
      height: 16px;
      width: 16px;
    }
    ::-webkit-scrollbar-button:active {
      border-color: var(--mac-darker-border) var(--mac-light-border) var(--mac-light-border) var(--mac-darker-border);
    }
    ::-webkit-scrollbar-corner { background: var(--mac-platinum); }

    /* === WINDOW DRAG & RESIZE === */
    .window-resize-handle {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      z-index: 60;
    }
    .window-resize-handle::after {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      background: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 1px,
        var(--mac-dark-border) 1px,
        var(--mac-dark-border) 2px
      );
    }
    #app.is-dragging {
      transition: none;
      user-select: none;
    }
    #app.is-dragging .window-titlebar { cursor: grabbing; }

    /* === RESPONSIVE === */
    @media (max-width: 640px) {
      /* Menu bar */
      #menu-bar { font-size: 11px; }
      .menu-item:not(.menu-app-name) { display: none; }
      .menu-right .menu-item:not(.menu-clock) { display: none; }

      /* Desktop area: flex container for app */
      #desktop-area {
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        overflow: hidden;
      }
      .desktop-icon { display: none; }

      /* App: fill available space */
      #app {
        position: relative;
        top: auto;
        left: auto;
        transform: none;
        width: 100%;
        max-width: 100%;
        max-height: none;
        flex: 1;
        box-shadow: none;
        border-left: none;
        border-right: none;
        border-top: none;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Dock hidden */
      #dock { display: none !important; }

      /* Titlebar: not draggable on mobile */
      .window-titlebar { cursor: default; }
      .window-resize-handle { display: none; }

      /* Window body fills remaining space */
      .window-body {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 6px;
      }

      /* Content area: no fixed max, fill available */
      .content-area {
        max-height: none;
        min-height: 200px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Stats */
      .stats-row { gap: 4px; margin-bottom: 8px; }
      .stat-card { min-width: 0; padding: 6px 4px; flex: 1 1 0; }
      .stat-value { font-size: 15px; }
      .stat-label { font-size: 9px; }

      /* Toolbar */
      .window-toolbar { flex-wrap: wrap; gap: 4px; padding: 6px 8px; }

      /* Tabs: fill width */
      .mac-tabs { flex-wrap: nowrap; }
      .mac-tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; }

      /* Buttons: touch-friendly */
      .mac-btn { min-height: 36px; padding: 6px 14px; font-size: 13px; }
      .mac-btn-sm { min-height: 32px; padding: 4px 10px; font-size: 12px; }

      /* Movie rows: proper tap targets */
      .movie-row { gap: 6px; padding: 6px 8px; min-height: 44px; }
      .movie-poster, .movie-poster-ph { width: 28px; height: 42px; }
      .movie-title { font-size: 13px; }
      .movie-date { font-size: 11px; min-width: 60px; }
      .movie-rating { font-size: 14px; min-width: 34px; }

      /* Watch items */
      .watch-item { padding: 6px 8px; min-height: 44px; gap: 6px; }
      .watch-title { font-size: 13px; }

      /* Search bar */
      .search-bar { flex-wrap: wrap; gap: 6px; margin: 6px 0; }
      .search-bar .mac-input { min-height: 34px; font-size: 13px; padding: 4px 8px; }
      #filter-input, #filter-watch { flex: 1 1 100%; order: -1; }
      #sort-select, #genre-filter, #tag-filter, #watch-source-filter {
        flex: 1 1 auto; min-height: 34px; font-size: 12px;
      }

      /* Forms: stack vertically */
      .add-form { padding: 10px; margin: 8px 0; }
      .form-row { flex-direction: column; gap: 6px; }
      .form-row label { font-size: 12px; }
      .form-row .mac-input {
        width: 100% !important; min-width: 0 !important;
        min-height: 36px; font-size: 14px; padding: 6px 8px;
      }
      .form-row .mac-input.date-input,
      .form-row .mac-input.title-input,
      .form-row .mac-input.rating-input { width: 100% !important; flex: none; }
      .form-tags { gap: 12px; margin: 6px 0; }
      .form-tags label { font-size: 13px; gap: 6px; min-height: 32px; display: flex; align-items: center; }
      .form-tags input[type="checkbox"] { width: 20px; height: 20px; }

      /* Edit inline: vertical */
      .edit-inline { flex-direction: column; align-items: stretch; gap: 6px; padding: 8px; }
      .edit-inline .mac-input { width: 100% !important; min-width: 0 !important; min-height: 34px; font-size: 13px; }
      .edit-inline .form-tags { width: 100%; }
      .edit-inline .mac-btn { width: 100%; }

      /* Movie action buttons */
      .movie-actions { gap: 4px; margin-left: 2px; }
      .movie-actions .mac-btn-sm { min-height: 28px; padding: 2px 8px; font-size: 11px; }

      /* Legend */
      .legend-box { padding: 6px 8px; margin-bottom: 8px; }

      /* Detail modal: full-screen on mobile */
      .detail-overlay { align-items: stretch; justify-content: stretch; padding: 0; }
      .detail-dialog {
        width: 100%; max-width: 100%; max-height: 100%; height: 100%;
        border: none; box-shadow: none; border-radius: 0;
        display: flex; flex-direction: column;
      }
      .detail-titlebar { position: sticky; top: 0; z-index: 1; flex-shrink: 0; }
      .detail-body {
        flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        padding: 12px; flex-direction: column;
      }
      .detail-poster { width: 120px; margin: 0 auto 12px; }
      .detail-section-content { font-size: 12px; }
      .provider-logo { width: 36px; height: 36px; }

      /* Watched modal */
      #watched-modal .detail-dialog {
        width: 100% !important; max-width: 100%; height: auto; max-height: 90vh;
        border: 2px solid var(--mac-black); align-self: center;
      }
      #watched-modal .detail-overlay { align-items: center; }
      #watched-modal .detail-body { padding: 16px; }
      #watched-modal .mac-input { width: 100% !important; min-height: 36px; font-size: 14px; }
      #watched-modal .mac-btn { min-height: 40px; font-size: 14px; }

      /* Login dialog */
      .login-dialog { width: 90%; max-width: 340px; }
      .login-body { padding: 16px; }
      .login-fields .mac-input { min-height: 36px; font-size: 14px; padding: 6px 8px; }
      .login-buttons .mac-btn { min-height: 40px; padding: 8px 24px; font-size: 14px; }

      /* Suggest form */
      #suggest-section .form-row { flex-direction: column; gap: 6px; }
      #suggest-section .mac-input { width: 100% !important; min-height: 36px; font-size: 14px; }

      /* TMDB dropdown */
      .tmdb-dropdown { max-height: 240px; }
      .tmdb-result { padding: 8px; font-size: 13px; min-height: 44px; }

      /* Status bar */
      .window-statusbar { font-size: 11px; padding: 4px 8px; }

      /* Scrollbars: thinner on mobile */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-button { height: 0; width: 0; display: none; }

      /* Undo bar */
      .undo-bar { font-size: 12px; padding: 8px; }
    }

    @media (max-width: 380px) {
      .movie-date { min-width: 46px; font-size: 10px; }
      .movie-rating { min-width: 28px; font-size: 12px; }
      .movie-poster, .movie-poster-ph { display: none; }
      .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
      .window-toolbar .mac-btn-sm { padding: 4px 8px; font-size: 11px; min-height: 30px; }
    }
  </style>
</head>
<body>

<div id="mac-desktop">

  <!-- Login Screen (Classic Mac dialog over desktop pattern) -->
  <div id="login-screen">
    <div class="login-dialog">
      <div class="login-titlebar">
        <span class="login-titlebar-text">Film Rankings</span>
      </div>
      <div class="login-body">
        <div class="login-row">
          <div class="login-icon">&#127916;</div>
          <div class="login-fields">
            <div style="font-size:12px;margin-bottom:4px">Enter password to access Film Rankings.</div>
            <label>
              Password:
              <input type="password" class="mac-input" id="pwd-input" style="flex:1;width:100%" autocomplete="off">
            </label>
          </div>
        </div>
        <p id="login-error"></p>
        <div class="login-buttons">
          <button class="mac-btn mac-btn-primary" onclick="attemptLogin()">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu Bar -->
  <div id="menu-bar">
    <div class="menu-item menu-app-name">Film Rankings</div>
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Help</div>
    <div class="menu-bar-spacer"></div>
    <div class="menu-right">
      <span class="menu-item" id="menu-mode-indicator"></span>
      <span class="menu-item menu-clock" id="menu-clock"></span>
    </div>
  </div>

  <!-- Desktop Area with Icons -->
  <div id="desktop-area">
    <div class="desktop-icon" ondblclick="focusAppWindow()">
      <div class="desktop-icon-img">&#127916;</div>
      <span class="desktop-icon-label">Film Rankings</span>
    </div>
  </div>

  <!-- App Window -->
  <div id="app">
    <div class="window-titlebar">
      <div class="close-box" onclick="logout()" title="Close"></div>
      <span class="window-title" id="titlebar-text">Film Rankings</span>
      <div class="zoom-box" title="Zoom"></div>
    </div>

    <div class="window-toolbar" id="toolbar">
      <button class="mac-btn mac-btn-sm" onclick="switchTab('rankings')">Rankings</button>
      <button class="mac-btn mac-btn-sm" onclick="switchTab('watchlist')">Watchlist</button>
      <div class="toolbar-divider"></div>
      <span class="toolbar-label" id="toolbar-mode"></span>
      <div class="toolbar-spacer"></div>
      <button class="mac-btn mac-btn-sm" id="toolbar-export" style="display:none" onclick="exportData()">Export</button>
      <button class="mac-btn mac-btn-sm" onclick="logout()">Lock</button>
    </div>

    <div class="window-body">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="s-total">0</div><div class="stat-label">Rated</div></div>
        <div class="stat-card"><div class="stat-value" id="s-avg">0</div><div class="stat-label">Average</div></div>
        <div class="stat-card"><div class="stat-value" id="s-tens">0</div><div class="stat-label">Perfect 10s</div></div>
        <div class="stat-card"><div class="stat-value" id="s-watch">0</div><div class="stat-label">Watchlist</div></div>
      </div>

      <div id="undo-container"></div>

      <!-- Tabs -->
      <div class="mac-tabs">
        <button class="mac-tab active" data-tab="rankings" onclick="switchTab('rankings')">Rankings</button>
        <button class="mac-tab" data-tab="watchlist" onclick="switchTab('watchlist')">Watchlist</button>
      </div>

      <!-- Rankings Panel -->
      <div class="tab-panel" id="tab-rankings">
        <div class="legend-box">
          <div class="legend-title">Rating Scale</div>
          <div class="scale-items">
            <div class="scale-item"><span class="scale-dot" style="background:#DAA520"></span> 9+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#2E8B57"></span> 7.5+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#E88B00"></span> 5+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#E02020"></span> 0+</div>
            <div class="scale-item"><span class="scale-dot" style="background:#808080"></span> DNF</div>
          </div>
          <div class="tag-items">
            <span><span class="tag tag-theater">T</span> Theater</span>
            <span><span class="tag tag-festival">F</span> Festival</span>
            <span><span class="tag tag-opening">OD</span> Opening Day</span>
            <span><span class="tag tag-prelist">PL</span> Pre-List</span>
          </div>
        </div>
        <div class="search-bar">
          <label for="filter-input">Find:</label>
          <input type="text" class="mac-input" id="filter-input" placeholder="Search movies..." oninput="render()">
          <select class="mac-input" id="sort-select" onchange="render()" style="width:auto">
            <option value="date">Date</option>
            <option value="score-desc">Score ↓</option>
            <option value="score-asc">Score ↑</option>
            <option value="title">Title</option>
          </select>
          <select class="mac-input" id="genre-filter" onchange="render()" style="width:auto">
            <option value="">All Genres</option>
          </select>
          <select class="mac-input" id="tag-filter" onchange="render()" style="width:auto">
            <option value="">All Tags</option>
            <option value="t">Theater</option>
            <option value="f">Festival</option>
            <option value="o">Opening Day</option>
            <option value="r">Pre-List</option>
            <option value="dnf">DNF</option>
          </select>
        </div>
        <div class="content-area" id="ratings-list"></div>
        <div id="add-rating-section" style="position:relative"></div>
      </div>

      <!-- Watchlist Panel -->
      <div class="tab-panel" id="tab-watchlist" style="display:none">
        <div class="search-bar">
          <label for="filter-watch">Find:</label>
          <input type="text" class="mac-input" id="filter-watch" placeholder="Search watchlist..." oninput="render()">
          <select class="mac-input" id="watch-source-filter" onchange="render()" style="width:auto">
            <option value="">All</option>
            <option value="mine">My Picks</option>
          </select>
        </div>
        <div class="content-area" id="watchlist-list"></div>
        <div id="add-watch-section" style="position:relative"></div>
        <div class="add-form" id="suggest-section">
          <span class="add-form-label">Suggest a Movie</span>
          <div class="form-row">
            <label>Movie:</label>
            <input class="mac-input title-input" id="suggest-title" placeholder="Movie title">
          </div>
          <div class="form-row">
            <label>Name:</label>
            <input class="mac-input" id="suggest-name" placeholder="Your name" style="width:120px">
            <label>Why?</label>
            <input class="mac-input" id="suggest-reason" placeholder="Optional reason" style="flex:1;min-width:100px">
            <button class="mac-btn" onclick="submitSuggestion()">Suggest</button>
          </div>
        </div>
      </div>

      <div id="export-section"></div>
    </div>

    <!-- Status Bar -->
    <div class="window-statusbar">
      <div class="sb-section" id="sb-mode">View Mode</div>
      <div class="sb-section" id="sb-count">0 films</div>
      <div class="sb-section" id="sb-tmdb">Ready</div>
    </div>
    <div class="window-resize-handle" id="resize-handle"></div>
  </div>

  <!-- Movie Detail Modal -->
  <div id="movie-detail-modal" class="detail-overlay" style="display:none" onclick="if(event.target===this)closeMovieDetail()">
    <div class="detail-dialog">
      <div class="detail-titlebar">
        <div class="close-box" onclick="closeMovieDetail()"></div>
        <span class="detail-titlebar-text" id="detail-title">Movie Details</span>
      </div>
      <div class="detail-body" id="detail-body">
        <div style="padding:20px;text-align:center;font-size:11px">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Watched Modal -->
  <div id="watched-modal" class="detail-overlay" style="display:none" onclick="if(event.target===this)closeWatchedModal()">
    <div class="detail-dialog" style="width:360px">
      <div class="detail-titlebar">
        <div class="close-box" onclick="closeWatchedModal()"></div>
        <span class="detail-titlebar-text" id="watched-modal-title">Mark as Watched</span>
      </div>
      <div class="detail-body" id="watched-modal-body" style="flex-direction:column;gap:10px">
      </div>
    </div>
  </div>

  <!-- Dock / Launcher Bar -->
  <div id="dock">
    <div class="dock-item dock-active" title="Film Rankings" ondblclick="focusAppWindow()">
      <span class="dock-icon">&#127916;</span>
      <span class="dock-label">Film Rankings</span>
    </div>
  </div>

</div>

<script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script data-cfasync="false">
// === CONFIG ===
const VIEW_HASH = 'db944067d6c7762bee2cd7cc3c55e9f35ccea4e885fa17930856aefe784a1b52';
const EDIT_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918';
const SESSION_KEY = 'ac_films_mode';

// === SUPABASE CONFIG ===
const SUPABASE_URL = 'https://jubkcyjmzykndwlaobus.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1YmtjeWptenlrbmR3bGFvYnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTUzODAsImV4cCI6MjA4Njc3MTM4MH0.TZETJCf3fjBSWgXE4SviUuMh5j18rvv55QW5TYacO0I';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// === TMDB CONFIG ===
const TMDB_KEY = '696e0c182f4e0c9df706d94b7bf50021';
const TMDB_BASE = 'https://api.themoviedb.org/3';
const TMDB_IMG = 'https://image.tmdb.org/t/p';
const TMDB_CACHE_KEY = 'ac_films_tmdb';
const TMDB_GENRES = {
  28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',
  99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',
  27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Sci-Fi',
  10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'
};

// === DEFAULT DATA ===
const DEFAULT_RATINGS = [
  ["01/31/26","Fallen Angels",7.25,[]],
  ["01/30/26","The Incredibles",9.25,["r"]],
  ["01/29/26","Iron Lung",7.75,["t","o"]],
  ["01/12/26","Marty Supreme",9.75,["t","f"]],
  ["01/02/26","Wicked: For Good",5.75,[]],
  ["12/28/25","Brightburn",6,[]],
  ["12/26/25","Public Enemies",7.5,[]],
  ["12/26/25","Top Gun: Maverick",9.75,["r"]],
  ["12/20/25","Five Nights at Freddy's 2",6.5,["t"]],
  ["12/18/25","El Camino",7.25,[]],
  ["12/16/25","Identity",7.25,[]],
  ["12/14/25","The Island",6.25,[]],
  ["12/01/25","Frankenstein",7.5,[]],
  ["11/27/25","True Romance",8.5,[]],
  ["11/27/25","Everyone's Hero",7.5,["r"]],
  ["11/26/25","12 Monkeys",7.25,[]],
  ["11/24/25","Money Ball",9.25,["r","f"]],
  ["11/19/25","Free Solo",6.5,[]],
  ["11/15/25","Madagascar 3: Europe's Most Wanted",9.25,["r","f"]],
  ["11/10/25","Troy",6.5,[]],
  ["10/29/25","John Wick: Chapter 4",9.5,["f"]],
  ["10/15/25","Jennifer's Body",7.5,[]],
  ["09/27/25","One Battle After Another",8,["t"]],
  ["09/09/25","Tron: Legacy",8,["r"]],
  ["09/08/25","Call Me by Your Name",7.25,[]],
  ["08/20/25","The King",8.75,["r"]],
  ["07/31/25","John Wick: Chapter 3",8.75,["r"]],
  ["07/31/25","John Wick: Chapter 2",8.5,["r"]],
  ["07/29/25","Ick",8.25,["t"]],
  ["07/27/25","The Dark Knight",9.5,["r"]],
  ["07/16/25","Shark Tale",7,["r"]],
  ["07/01/25","Ballerina",8.5,["t"]],
  ["06/30/25","F1",9.25,["t"]],
  ["06/21/25","John Wick",9.25,["r"]],
  ["06/20/25","The Accountant 2","DNF",[]],
  ["06/13/25","The Girl Next Door",7.75,[]],
  ["05/27/25","Late Night with the Devil",6,[]],
  ["05/25/25","Tropic Thunder",9,["f"]],
  ["05/25/25","How to Train Your Dragon: The Hidden World",8.5,[]],
  ["05/24/25","How to Train Your Dragon 2",8.5,["r"]],
  ["05/24/25","How to Train Your Dragon",9.25,["r","f"]],
  ["05/24/25","Air Force Elite - Thunderbirds",6,[]],
  ["05/23/25","Mission: Impossible - Final Reckoning",9,["t","f","o"]],
  ["05/04/25","The Fighter",8.75,["f"]],
  ["05/02/25","Thunderbolts",8.25,["t","o"]],
  ["05/02/25","Anora",8.5,[]],
  ["05/01/25","The White House Effect",5.75,["f"]],
  ["04/29/25","OBEX",4.5,["f"]],
  ["04/29/25","The Kingdom",9,["f"]],
  ["04/28/25","Drive",8,[]],
  ["04/24/25","Warfare",8,[]],
  ["04/12/25","Goodfellas",8.75,[]],
  ["04/04/25","Minecraft",6.25,["t","o"]],
  ["03/26/25","Mickey 17",6,["t"]],
  ["03/23/25","Electric State",6,[]],
  ["02/26/25","The Monkey",5.75,["t"]],
  ["02/19/25","Companion",7.5,["t"]],
  ["02/05/25","Paul Blart: Mall Cop",7.25,["r"]],
  ["01/15/25","Better Man",8.5,["t"]],
  ["01/07/25","Wicked",8.5,[]],
  ["01/06/25","Boy Kills World",6,[]],
  ["01/03/25","Immaculate",6.5,[]],
  ["12/30/24","Gladiator 2",7.75,[]],
  ["12/28/24","Oddity",6.75,[]],
  ["12/27/24","Split",7.75,["r"]],
  ["12/27/24","Gladiator",8.75,["r"]],
  ["12/23/24","Transformers One",7.5,["r"]],
  ["12/16/24","Spy Game",6,[]],
  ["12/13/24","Subservience",6,[]],
  ["11/28/24","Oz",6.5,[]],
  ["11/27/24","Smile 2",7,[]],
  ["10/01/24","Wolfs",6.75,[]],
  ["09/13/24","The Disaster Artist",7,[]],
  ["05/30/24","Prom Dates",6.5,[]],
  ["05/20/24","Se7en",8.5,[]],
  ["05/18/24","Sicario",9,["f"]],
  ["05/05/24","Oldboy","DNF",[]],
  ["04/07/24","The Breath",8,[]],
  ["04/03/24","Imperium",8,[]],
  ["04/01/24","High Life",7.5,[]],
  ["03/02/24","Free Fire",7.5,[]],
  ["03/02/24","Mayhem","DNF",[]],
  ["03/01/24","Office Space",8,[]],
  ["02/29/24","Belko Experiment","DNF",[]],
  ["02/22/24","Dune: Part Two",10,["t","o"]],
  ["01/22/24","Kidnapping Inc",8.75,["f"]],
  ["01/21/24","A Different Man",8.75,["f"]],
  ["01/20/24","Love Lies Bleeding",8.25,["f"]],
  ["01/19/24","It's What's Inside",7.5,["f"]],
  ["01/19/24","Sasquatch Sunset",6,["f"]],
  ["01/14/24","Vivarium",6,[]],
  ["01/05/24","M.I.B",7.5,["r"]],
  ["01/05/24","R.I.P.D.",6,[]],
  ["01/04/24","The Creator",7.5,[]],
  ["12/25/23","The Other Guys",7.25,[]],
  ["12/24/23","The Lodge",6.5,[]],
  ["12/21/23","I'm Thinking of Ending Things",6,[]],
  ["12/20/23","The Hunger Games (2023)",7,[]],
  ["11/20/23","Hotel Transylvania: Transformania",5.75,[]],
  ["11/20/23","Hotel Transylvania 3",6.5,["r"]],
  ["11/20/23","Hotel Transylvania 2",7,["r"]],
  ["11/20/23","Hotel Transylvania",8.25,["r"]],
  ["10/05/23","Rejuvenation",3.5,["t","o"]],
  ["09/30/23","Better Luck Tomorrow",7.25,[]],
  ["09/17/23","Bottoms",8.25,["t"]],
  ["09/17/23","Ted",6.5,[]],
  ["09/07/23","The Speed Cubers",4.5,[]],
  ["09/05/23","The Big Short",8.25,[]],
  ["08/13/23","The Mist",5,[]],
  ["08/10/23","Sorry to Bother You",9,["f"]],
  ["08/10/23","La La Land",9,["f"]],
  ["08/10/23","The Nice Guys",6.5,[]],
  ["08/09/23","Gran Turismo",7.5,["t","o"]],
  ["07/21/23","Barbie",9,["t","f","o"]],
  ["07/21/23","Oppenheimer",9.5,["t","f","o"]],
  ["07/14/23","Butch Cassidy and the Sundance Kid",6.5,[]],
  ["07/10/23","Mission: Impossible - Dead Reckoning",9.5,["t","f","o"]],
  ["07/09/23","Ex Machina",9.5,[]],
  ["07/09/23","The Mask",8.75,["r"]],
  ["07/08/23","Journey 2: The Mysterious Island",3,["r"]],
  ["07/08/23","A Trip to the Moon",9.25,[]],
  ["07/06/23","Megamind",8.75,["r"]],
  ["07/05/23","Catch Me If You Can",8.5,[]],
  ["07/04/23","I, Tonya",8.5,[]],
  ["07/03/23","Focus",8.25,[]],
  ["07/02/23","2001: A Space Odyssey",7.5,[]],
  ["07/01/23","Amsterdam",5.75,[]],
  ["06/30/23","Harley Quinn: Birds of Prey",9,[]],
  ["06/30/23","Indiana Jones and the Dial of Destiny",7,["t","o"]],
  ["06/30/23","Suicide Squad",6,[]],
  ["06/29/23","Evil Dead Rise",4,[]],
  ["06/28/23","The Suicide Squad",5.25,[]],
  ["06/24/23","Spider-Man: Into the Spider-Verse",9.5,["f"]],
  ["06/23/23","Spider-Man: Across the Spider-Verse",9.75,["t","f"]],
  ["06/22/23","Asteroid City",8,["t"]],
  ["06/20/23","Black Panther: Wakanda Forever",5,[]],
  ["06/18/23","Inglorious Bastards",9,["r"]],
  ["06/17/23","Toy Story 2",8.75,["r"]],
  ["06/10/23","Fight Club",8.5,[]],
  ["06/09/23","Babylon",10,["f"]],
  ["06/06/23","Glass Onion: Knives Out",5.5,[]],
  ["06/04/23","Deadpool 2",7.75,[]],
  ["06/04/23","Deadpool",8.5,[]],
  ["06/03/23","Bullet Train",8.75,["r"]],
  ["06/03/23","Mario Movie",8.25,[]],
  ["05/27/23","American Psycho",9,["f"]],
  ["05/24/23","Once Upon a Time in Hollywood",7,[]],
  ["05/19/23","Blade Runner 2049",9.5,["r","f"]],
  ["05/17/23","Dune",9.75,["r","f"]],
  ["05/10/23","Pirates of the Caribbean 1",10,["r","f"]]
];

const DEFAULT_WATCHLIST = [
  "Fallen Angels","GOAT","Heretics","Sin City","Chronicle",
  "What Happened to Monday","Woman in Black","Guns Akimbo","Anthropoid",
  "True Detective","The Apprentice","Till Death","Run Lola Run",
  "Snatch","Rush","It Follows","LA Confidential","Mr. & Mrs. Smith",
  "Shaolin Soccer","The Aviator","Thelma & Louise","Pretty Woman",
  "3 Idiots","Taare Zameen Par","Apocalypse Now","Extraction","Chaplin",
  "The Revenant","Cleopatra (1963)","Secrets of the Octopus","The Gray Man",
  "Crazy, Stupid, Love","Beautiful Boy","Bombshell","Ad Astra",
  "Spring Breakers","Saturday Night","The Shining","Tron",
  "Judas and the Black Messiah","Psycho","Killer Joe"
];

// === STATE ===
let mode = null;
let ratings = [];
let watchlist = [];
let activeTab = 'rankings';
let editingId = null;
let tmdbCache = {};
let tmdbMatchRunning = false;
let seeding = false;
let adjustedScores = {};
let rewatchCounts = {};
let lastDeleted = null;

// === UTILITY ===
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function parseDate(d) {
  const [mm,dd,yy] = d.split('/').map(Number);
  return { month: mm, day: dd, year: 2000 + yy, sort: (2000+yy)*10000 + mm*100 + dd };
}

function computeSortOrder(dateStr) {
  const [mm,dd,yy] = dateStr.split('/').map(Number);
  return (2000+yy)*10000 + mm*100 + dd;
}

function todayStr() {
  const d = new Date();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const yy = String(d.getFullYear() % 100).padStart(2, '0');
  return `${mm}/${dd}/${yy}`;
}

function ratingClass(r) {
  if (r === 'DNF') return 'rating-dnf';
  if (r >= 9) return 'rating-gold';
  if (r >= 7.5) return 'rating-green';
  if (r >= 5) return 'rating-orange';
  return 'rating-red';
}

function ratingDisplay(r) {
  if (r === 'DNF') return 'DNF';
  return Number.isInteger(r) ? r.toString() : r.toFixed(2).replace(/0$/, '');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// === AUTH ===
async function attemptLogin() {
  const pwd = document.getElementById('pwd-input').value;
  if (!pwd) return;
  const hash = await sha256(pwd);
  if (hash === EDIT_HASH) mode = 'edit';
  else if (hash === VIEW_HASH) mode = 'view';
  else {
    document.getElementById('login-error').textContent = 'Incorrect password.';
    document.getElementById('pwd-input').value = '';
    return;
  }
  sessionStorage.setItem(SESSION_KEY, mode);
  await showApp();
}

function logout() {
  mode = null;
  sessionStorage.removeItem(SESSION_KEY);
  document.getElementById('app').style.display = 'none';
  document.getElementById('menu-bar').style.display = 'none';
  document.getElementById('dock').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('pwd-input').value = '';
  document.getElementById('login-error').textContent = '';
}

async function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('menu-bar').style.display = 'flex';
  document.getElementById('dock').style.display = 'flex';
  document.getElementById('titlebar-text').textContent =
    'Film Rankings' + (mode === 'edit' ? ' - Edit Mode' : '');
  document.getElementById('toolbar-mode').textContent =
    mode === 'edit' ? 'Edit Mode' : 'View Mode';
  document.getElementById('toolbar-export').style.display =
    mode === 'edit' ? '' : 'none';
  document.getElementById('sb-mode').textContent =
    mode === 'edit' ? 'Edit Mode' : 'View Mode';
  document.getElementById('menu-mode-indicator').textContent =
    mode === 'edit' ? 'Edit' : 'View';
  await loadData();
  await loadTMDBCache();
  render();
  await warmCache();
  autoMatchTMDB();
}

function focusAppWindow() {
  const app = document.getElementById('app');
  if (app) app.style.display = 'flex';
}

// === DATA ===
async function loadData() {
  const { data: dbRatings, error: ratErr } = await db
    .from('ratings')
    .select('*')
    .order('sort_order', { ascending: false });

  if (ratErr) {
    console.error('Failed to load ratings:', ratErr);
    return;
  }

  if (dbRatings && dbRatings.length > 0) {
    ratings = dbRatings.map(r => ({
      id: r.id,
      date: r.date,
      title: r.title,
      rating: r.rating === 'DNF' ? 'DNF' : parseFloat(r.rating),
      tags: r.tags || [],
      tmdb_id: r.tmdb_id
    }));
  } else if (!seeding) {
    await seedDefaults();
    return;
  }

  const { data: dbWatch, error: watchErr } = await db
    .from('watchlist')
    .select('*')
    .order('created_at', { ascending: false })
    .order('id', { ascending: true });

  if (watchErr) {
    console.error('Failed to load watchlist:', watchErr);
    return;
  }

  if (dbWatch && dbWatch.length > 0) {
    watchlist = dbWatch.map(w => ({ id: w.id, title: w.title, tmdb_id: w.tmdb_id, suggested_by: w.suggested_by, reason: w.reason }));
  }

  // Load rewatch counts
  const { data: rwData } = await db.from('rewatches').select('rating_id');
  rewatchCounts = {};
  if (rwData) {
    rwData.forEach(r => { rewatchCounts[r.rating_id] = (rewatchCounts[r.rating_id] || 0) + 1; });
  }
}

async function seedDefaults() {
  seeding = true;
  const rows = DEFAULT_RATINGS.map(r => ({
    date: r[0],
    title: r[1],
    rating: String(r[2]),
    tags: r[3] || [],
    tmdb_id: r[4] || null,
    sort_order: computeSortOrder(r[0])
  }));
  await db.from('ratings').insert(rows);

  const watchRows = DEFAULT_WATCHLIST.map(t => ({ title: t }));
  await db.from('watchlist').insert(watchRows);

  seeding = false;
  await loadData();
}

// === TMDB ===
async function loadTMDBCache() {
  // Fast local load first
  try {
    const s = localStorage.getItem(TMDB_CACHE_KEY);
    if (s) tmdbCache = JSON.parse(s);
  } catch(e) { tmdbCache = {}; }
  // Merge remote data (fills gaps from other browsers/devices)
  try {
    const { data } = await db.from('tmdb_cache').select('data').eq('id', 1).single();
    if (data && data.data) {
      const remote = data.data;
      let merged = false;
      for (const [id, entry] of Object.entries(remote)) {
        if (!tmdbCache[id]) { tmdbCache[id] = entry; merged = true; }
      }
      if (merged) localStorage.setItem(TMDB_CACHE_KEY, JSON.stringify(tmdbCache));
    }
  } catch(e) { /* Supabase unavailable, localStorage is fine */ }
}

let tmdbSaveTimer = null;
function saveTMDBCache() {
  localStorage.setItem(TMDB_CACHE_KEY, JSON.stringify(tmdbCache));
  clearTimeout(tmdbSaveTimer);
  tmdbSaveTimer = setTimeout(flushTMDBCache, 2000);
}

async function flushTMDBCache() {
  try {
    await db.from('tmdb_cache').upsert({ id: 1, data: tmdbCache, updated_at: new Date().toISOString() });
  } catch(e) { /* silent - localStorage is the fallback */ }
}

async function tmdbSearch(query, year) {
  let url = `${TMDB_BASE}/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}`;
  if (year) url += `&year=${year}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('TMDB ' + resp.status);
  return resp.json();
}

function tmdbCacheFromResult(r) {
  return {
    poster_path: r.poster_path,
    release_date: r.release_date || '',
    genres: (r.genre_ids || []).map(id => TMDB_GENRES[id]).filter(Boolean).slice(0, 3),
    ts: Date.now()
  };
}

function getPosterUrl(path, size) {
  if (!path) return null;
  return `${TMDB_IMG}/${size || 'w92'}${path}`;
}

function getTMDBInfo(tmdbId) {
  if (!tmdbId || !tmdbCache[tmdbId]) return null;
  return tmdbCache[tmdbId];
}

async function autoMatchTMDB() {
  if (tmdbMatchRunning) return;
  tmdbMatchRunning = true;
  const unmatched = ratings.filter(r => !r.tmdb_id);
  let matched = 0;
  const total = unmatched.length;

  for (let i = 0; i < unmatched.length; i += 3) {
    const batch = unmatched.slice(i, i + 3);
    const promises = batch.map(async movie => {
      try {
        let searchTitle = movie.title;
        let yearFilter = null;
        const ym = movie.title.match(/\((\d{4})\)$/);
        if (ym) {
          yearFilter = ym[1];
          searchTitle = movie.title.replace(/\s*\(\d{4}\)$/, '');
        }
        let data = await tmdbSearch(searchTitle, yearFilter);
        if ((!data.results || data.results.length === 0) && yearFilter) {
          data = await tmdbSearch(searchTitle, null);
        }
        if (data.results && data.results.length > 0) {
          const best = data.results[0];
          movie.tmdb_id = best.id;
          tmdbCache[best.id] = tmdbCacheFromResult(best);
          await db.from('ratings').update({ tmdb_id: best.id }).eq('id', movie.id);
          matched++;
        }
      } catch(e) { /* skip */ }
    });
    await Promise.all(promises);
    saveTMDBCache();
    document.getElementById('sb-tmdb').textContent =
      `TMDB: ${i + batch.length}/${total}`;
    render();
    await new Promise(r => setTimeout(r, 350));
  }
  // Also match watchlist items
  const unmatchedWatch = watchlist.filter(w => !w.tmdb_id);
  for (let i = 0; i < unmatchedWatch.length; i += 3) {
    const batch = unmatchedWatch.slice(i, i + 3);
    const promises = batch.map(async item => {
      try {
        let searchTitle = item.title;
        let yearFilter = null;
        const ym = item.title.match(/\((\d{4})\)$/);
        if (ym) {
          yearFilter = ym[1];
          searchTitle = item.title.replace(/\s*\(\d{4}\)$/, '');
        }
        let data = await tmdbSearch(searchTitle, yearFilter);
        if ((!data.results || data.results.length === 0) && yearFilter) {
          data = await tmdbSearch(searchTitle, null);
        }
        if (data.results && data.results.length > 0) {
          const best = data.results[0];
          item.tmdb_id = best.id;
          tmdbCache[best.id] = tmdbCacheFromResult(best);
          await db.from('watchlist').update({ tmdb_id: best.id }).eq('id', item.id);
        }
      } catch(e) { /* skip */ }
    });
    await Promise.all(promises);
    saveTMDBCache();
    render();
    await new Promise(r => setTimeout(r, 350));
  }

  document.getElementById('sb-tmdb').textContent = `TMDB: ${matched} matched`;
  await fetchWatchlistProviders();
  tmdbMatchRunning = false;
}

async function warmCache() {
  const needsCache = [
    ...ratings.filter(r => r.tmdb_id && !tmdbCache[r.tmdb_id]),
    ...watchlist.filter(w => w.tmdb_id && !tmdbCache[w.tmdb_id])
  ];
  const seen = new Set();
  const unique = needsCache.filter(m => {
    if (seen.has(m.tmdb_id)) return false;
    seen.add(m.tmdb_id);
    return true;
  });
  if (!unique.length) return;
  document.getElementById('sb-tmdb').textContent = `TMDB: warming cache...`;
  for (let i = 0; i < unique.length; i += 3) {
    const batch = unique.slice(i, i + 3);
    await Promise.all(batch.map(async m => {
      try {
        const url = `${TMDB_BASE}/movie/${m.tmdb_id}?api_key=${TMDB_KEY}&append_to_response=watch/providers`;
        const resp = await fetch(url);
        if (!resp.ok) return;
        const data = await resp.json();
        tmdbCache[m.tmdb_id] = {
          poster_path: data.poster_path,
          release_date: data.release_date || '',
          genres: (data.genres || []).map(g => g.name).slice(0, 3),
          ts: Date.now()
        };
        const usProviders = data['watch/providers']?.results?.US;
        if (usProviders) {
          tmdbCache[m.tmdb_id].providers = {
            flatrate: (usProviders.flatrate || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
            rent: (usProviders.rent || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
            buy: (usProviders.buy || []).map(p => ({ name: p.provider_name, logo: p.logo_path }))
          };
        }
      } catch(e) { /* skip */ }
    }));
    saveTMDBCache();
    document.getElementById('sb-tmdb').textContent = `TMDB: cache ${i + batch.length}/${unique.length}`;
    render();
    await new Promise(r => setTimeout(r, 350));
  }
  document.getElementById('sb-tmdb').textContent = 'TMDB: Ready';
}

// TMDB search for add form
let searchTimeout = null;
function onTitleSearch(val) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('tmdb-dropdown');
  if (!dd) return;
  if (val.length < 2) { dd.style.display = 'none'; return; }
  searchTimeout = setTimeout(async () => {
    try {
      const data = await tmdbSearch(val, null);
      if (!data.results || data.results.length === 0) {
        dd.style.display = 'none'; return;
      }
      let html = '';
      data.results.slice(0, 6).forEach(r => {
        const yr = r.release_date ? r.release_date.substring(0, 4) : '?';
        const poster = r.poster_path
          ? `<img src="${getPosterUrl(r.poster_path, 'w92')}" alt="">`
          : '<div class="tmdb-result-ph"></div>';
        html += `<div class="tmdb-result" data-id="${r.id}" data-title="${escHtml(r.title)}"
                  onclick="selectTMDBResult(this)">
          ${poster}<span>${escHtml(r.title)} (${yr})</span>
        </div>`;
      });
      dd.innerHTML = html;
      dd.style.display = 'block';
    } catch(e) { dd.style.display = 'none'; }
  }, 400);
}

function selectTMDBResult(el) {
  const id = parseInt(el.dataset.id);
  const title = el.dataset.title;
  document.getElementById('new-title').value = title;
  const hiddenId = document.getElementById('new-tmdb-id');
  if (hiddenId) hiddenId.value = id;
  const dd = document.getElementById('tmdb-dropdown');
  if (dd) dd.style.display = 'none';
  if (!tmdbCache[id]) {
    tmdbSearch(title, null).then(data => {
      if (data.results) {
        const match = data.results.find(r => r.id === id);
        if (match) { tmdbCache[id] = tmdbCacheFromResult(match); saveTMDBCache(); }
      }
    }).catch(() => {});
  }
}

// === UNDO ===
function showUndo(type, data) {
  if (lastDeleted && lastDeleted.timer) clearTimeout(lastDeleted.timer);
  lastDeleted = { type, data, timer: setTimeout(clearUndo, 10000) };
}

function clearUndo() {
  lastDeleted = null;
  render();
}

async function undoDelete() {
  if (!lastDeleted) return;
  const { type, data } = lastDeleted;
  if (type === 'rating') {
    await db.from('ratings').insert({
      date: data.date, title: data.title, rating: String(data.rating),
      tags: data.tags || [], tmdb_id: data.tmdb_id,
      sort_order: computeSortOrder(data.date)
    });
  } else {
    await db.from('watchlist').insert({ title: data.title, tmdb_id: data.tmdb_id });
  }
  clearTimeout(lastDeleted.timer);
  lastDeleted = null;
  await loadData();
  render();
}

// === EDIT TMDB SEARCH ===
let editSearchTimeout = null;
function onEditTitleSearch(val) {
  clearTimeout(editSearchTimeout);
  const dd = document.getElementById('edit-tmdb-dropdown');
  if (!dd) return;
  if (val.length < 2) { dd.style.display = 'none'; return; }
  editSearchTimeout = setTimeout(async () => {
    try {
      const data = await tmdbSearch(val, null);
      if (!data.results || data.results.length === 0) {
        dd.style.display = 'none'; return;
      }
      let html = '';
      data.results.slice(0, 6).forEach(r => {
        const yr = r.release_date ? r.release_date.substring(0, 4) : '?';
        const poster = r.poster_path
          ? `<img src="${getPosterUrl(r.poster_path, 'w92')}" alt="">`
          : '<div class="tmdb-result-ph"></div>';
        html += `<div class="tmdb-result" data-id="${r.id}" data-title="${escHtml(r.title)}"
                  onclick="selectEditTMDBResult(this)">
          ${poster}<span>${escHtml(r.title)} (${yr})</span>
        </div>`;
      });
      dd.innerHTML = html;
      dd.style.display = 'block';
    } catch(e) { dd.style.display = 'none'; }
  }, 400);
}

function selectEditTMDBResult(el) {
  const id = parseInt(el.dataset.id);
  document.getElementById('edit-title').value = el.dataset.title;
  document.getElementById('edit-tmdb-id').value = id;
  document.getElementById('edit-tmdb-dropdown').style.display = 'none';
  if (!tmdbCache[id]) {
    tmdbSearch(el.dataset.title, null).then(data => {
      if (data.results) {
        const match = data.results.find(r => r.id === id);
        if (match) { tmdbCache[id] = tmdbCacheFromResult(match); saveTMDBCache(); }
      }
    }).catch(() => {});
  }
}

function clearEditTmdb() {
  const el = document.getElementById('edit-tmdb-id');
  if (el) el.value = '';
}

// === MOVIE DETAIL MODAL ===
async function fetchMovieDetails(tmdbId) {
  const url = `${TMDB_BASE}/movie/${tmdbId}?api_key=${TMDB_KEY}&append_to_response=credits,watch/providers`;
  const resp = await fetch(url);
  if (!resp.ok) return null;
  return resp.json();
}

function cacheMovieDetails(tmdbId, details) {
  if (!tmdbCache[tmdbId]) tmdbCache[tmdbId] = {};
  const c = tmdbCache[tmdbId];
  c.runtime = details.runtime;
  c.director = (details.credits?.crew || []).filter(p => p.job === 'Director').map(p => p.name);
  c.cast = (details.credits?.cast || []).slice(0, 5).map(p => p.name);
  c.producers = (details.credits?.crew || []).filter(p => p.job === 'Producer').map(p => p.name).slice(0, 3);
  c.companies = (details.production_companies || []).map(co => co.name);
  const usProviders = details['watch/providers']?.results?.US;
  if (usProviders) {
    c.providers = {
      flatrate: (usProviders.flatrate || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
      rent: (usProviders.rent || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
      buy: (usProviders.buy || []).map(p => ({ name: p.provider_name, logo: p.logo_path }))
    };
  }
  saveTMDBCache();
}

async function showMovieDetail(tmdbId) {
  if (!tmdbId) return;
  const modal = document.getElementById('movie-detail-modal');
  const titleEl = document.getElementById('detail-title');
  const bodyEl = document.getElementById('detail-body');
  modal.style.display = 'flex';
  bodyEl.innerHTML = '<div style="padding:20px;text-align:center;font-size:11px">Loading...</div>';
  titleEl.textContent = 'Movie Details';

  const details = await fetchMovieDetails(tmdbId);
  if (!details) {
    bodyEl.innerHTML = '<div style="padding:20px;text-align:center;font-size:11px">Could not load details.</div>';
    return;
  }
  cacheMovieDetails(tmdbId, details);

  const posterUrl = details.poster_path ? getPosterUrl(details.poster_path, 'w185') : null;
  const posterHtml = posterUrl
    ? `<img src="${posterUrl}" alt="">`
    : '<div style="width:154px;height:231px;background:#EEE;border:1px solid #CCC;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999">No poster</div>';

  const year = details.release_date ? details.release_date.substring(0, 4) : '?';
  const runtime = details.runtime ? `${details.runtime} min` : '';
  const genres = (details.genres || []).map(g => g.name).slice(0, 3).join(', ');
  const metaParts = [year, runtime, genres].filter(Boolean);

  const directors = (details.credits?.crew || []).filter(p => p.job === 'Director').map(p => p.name);
  const producers = (details.credits?.crew || []).filter(p => p.job === 'Producer').map(p => p.name).slice(0, 3);
  const cast = (details.credits?.cast || []).slice(0, 5).map(p => p.name);
  const companies = (details.production_companies || []).map(co => co.name);

  titleEl.textContent = details.title || 'Movie Details';

  let sections = '';
  if (directors.length) {
    sections += `<div class="detail-section"><div class="detail-section-title">Director</div><div class="detail-section-content">${escHtml(directors.join(', '))}</div></div>`;
  }
  if (cast.length) {
    sections += `<div class="detail-section"><div class="detail-section-title">Cast</div><div class="detail-section-content">${escHtml(cast.join(', '))}</div></div>`;
  }
  if (producers.length) {
    sections += `<div class="detail-section"><div class="detail-section-title">Producers</div><div class="detail-section-content">${escHtml(producers.join(', '))}</div></div>`;
  }
  if (companies.length) {
    sections += `<div class="detail-section"><div class="detail-section-title">Production</div><div class="detail-section-content">${escHtml(companies.join(', '))}</div></div>`;
  }

  const usProviders = details['watch/providers']?.results?.US;
  if (usProviders) {
    const renderProviders = (list, label) => {
      if (!list || !list.length) return '';
      const logos = list.map(p =>
        p.logo_path
          ? `<img class="provider-logo" src="${TMDB_IMG}/w45${p.logo_path}" alt="${escHtml(p.provider_name)}" title="${escHtml(p.provider_name)}">`
          : `<span style="font-size:10px;padding:2px 4px;border:1px solid #CCC;border-radius:3px">${escHtml(p.provider_name)}</span>`
      ).join('');
      return `<div class="detail-section"><div class="detail-section-title">${label}</div><div class="provider-logos">${logos}</div></div>`;
    };
    sections += renderProviders(usProviders.flatrate, 'Stream');
    sections += renderProviders(usProviders.rent, 'Rent');
    sections += renderProviders(usProviders.buy, 'Buy');
  }

  // Fetch rewatch dates for this movie
  const ratingEntry = ratings.find(r => r.tmdb_id === tmdbId);
  let rewatchHtml = '';
  if (ratingEntry) {
    const { data: rwDates } = await db.from('rewatches').select('id, watched_at').eq('rating_id', ratingEntry.id).order('watched_at', { ascending: true });
    if (rwDates && rwDates.length > 0) {
      const dateList = rwDates.map(r => {
        const d = new Date(r.watched_at);
        const deleteBtn = mode === 'edit' ? ` <span onclick="event.stopPropagation();deleteRewatch(${r.id},${tmdbId})" style="cursor:pointer;color:#999;font-size:10px;margin-left:4px" title="Remove">&times;</span>` : '';
        return `<div style="font-size:11px;color:#333;margin:1px 0">${d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })} at ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}${deleteBtn}</div>`;
      }).join('');
      rewatchHtml = `<div class="detail-section"><div class="detail-section-title">Rewatches (${rwDates.length})</div><div class="detail-section-content">${dateList}</div></div>`;
    }
  }

  bodyEl.innerHTML = `
    <div class="detail-poster">${posterHtml}</div>
    <div class="detail-info">
      <h2>${escHtml(details.title || '')}</h2>
      <div class="detail-meta">${escHtml(metaParts.join(' \u00B7 '))}</div>
      ${sections}
      ${rewatchHtml}
    </div>`;
}

function closeMovieDetail() {
  document.getElementById('movie-detail-modal').style.display = 'none';
}

// === WATCH PROVIDERS FETCH ===
async function fetchWatchlistProviders() {
  const toFetch = watchlist.filter(w => w.tmdb_id && (!tmdbCache[w.tmdb_id] || !tmdbCache[w.tmdb_id].providers));
  for (let i = 0; i < toFetch.length; i += 3) {
    const batch = toFetch.slice(i, i + 3);
    await Promise.all(batch.map(async w => {
      try {
        const url = `${TMDB_BASE}/movie/${w.tmdb_id}?api_key=${TMDB_KEY}&append_to_response=watch/providers`;
        const resp = await fetch(url);
        if (!resp.ok) return;
        const data = await resp.json();
        if (!tmdbCache[w.tmdb_id]) tmdbCache[w.tmdb_id] = {};
        const usProviders = data['watch/providers']?.results?.US;
        if (usProviders) {
          tmdbCache[w.tmdb_id].providers = {
            flatrate: (usProviders.flatrate || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
            rent: (usProviders.rent || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
            buy: (usProviders.buy || []).map(p => ({ name: p.provider_name, logo: p.logo_path }))
          };
        }
      } catch(e) { /* skip */ }
    }));
    saveTMDBCache();
    render();
    await new Promise(r => setTimeout(r, 350));
  }
}

// === RENDER ===
function computeAdjustedScores() {
  adjustedScores = {};
  const nr = ratings.filter(r => r.rating !== 'DNF');
  if (!nr.length) return;
  const avg = nr.reduce((s, r) => s + r.rating, 0) / nr.length;
  if (avg === 0) return;
  nr.forEach(r => {
    let adj;
    if (r.rating <= avg) {
      adj = (r.rating / avg) * 5;
    } else {
      adj = 5 + ((r.rating - avg) / (10 - avg)) * 5;
    }
    adjustedScores[r.id] = Math.round(adj * 100) / 100;
  });
}

function populateGenreFilter() {
  const sel = document.getElementById('genre-filter');
  if (!sel) return;
  const current = sel.value;
  const genres = new Set();
  ratings.forEach(r => {
    const tmdb = getTMDBInfo(r.tmdb_id);
    if (tmdb && tmdb.genres) tmdb.genres.forEach(g => genres.add(g));
  });
  const sorted = [...genres].sort();
  sel.innerHTML = '<option value="">All Genres</option>' +
    sorted.map(g => `<option value="${g}"${g === current ? ' selected' : ''}>${g}</option>`).join('');
}

function populateWatchSourceFilter() {
  const sel = document.getElementById('watch-source-filter');
  if (!sel) return;
  const current = sel.value;
  const hasSuggestions = watchlist.some(w => w.suggested_by);
  let html = '<option value="">All</option><option value="mine">Andrew\'s</option>';
  if (hasSuggestions) html += '<option value="__suggestions__">Suggested</option>';
  if (mode === 'edit') {
    const names = new Set();
    watchlist.forEach(w => { if (w.suggested_by) names.add(w.suggested_by); });
    const sorted = [...names].sort();
    sorted.forEach(n => { html += `<option value="${n}"${n === current ? ' selected' : ''}>${escHtml(n)}</option>`; });
  }
  sel.innerHTML = html;
  if (current && sel.querySelector(`option[value="${CSS.escape(current)}"]`)) sel.value = current;
}

async function submitSuggestion() {
  const title = document.getElementById('suggest-title').value.trim();
  const name = document.getElementById('suggest-name').value.trim();
  const reason = document.getElementById('suggest-reason').value.trim();
  if (!title || !name) return;
  if (ratings.some(r => r.title.toLowerCase() === title.toLowerCase())) {
    alert(`"${title}" has already been watched!`);
    return;
  }
  if (watchlist.some(w => w.title.toLowerCase() === title.toLowerCase())) {
    alert(`"${title}" is already on the watchlist!`);
    return;
  }
  const { data: inserted } = await db.from('watchlist').insert({
    title,
    suggested_by: name,
    reason: reason || null
  }).select().single();
  await loadData();
  render();
  document.getElementById('suggest-title').value = '';
  document.getElementById('suggest-reason').value = '';
  // Auto-match TMDB
  if (inserted) {
    try {
      const searchData = await tmdbSearch(title, null);
      if (searchData.results && searchData.results.length > 0) {
        const best = searchData.results[0];
        await db.from('watchlist').update({ tmdb_id: best.id }).eq('id', inserted.id);
        tmdbCache[best.id] = tmdbCacheFromResult(best);
        const detailResp = await fetch(`${TMDB_BASE}/movie/${best.id}?api_key=${TMDB_KEY}&append_to_response=watch/providers`);
        if (detailResp.ok) {
          const detail = await detailResp.json();
          const usP = detail['watch/providers']?.results?.US;
          if (usP) {
            tmdbCache[best.id].providers = {
              flatrate: (usP.flatrate || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
              rent: (usP.rent || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
              buy: (usP.buy || []).map(p => ({ name: p.provider_name, logo: p.logo_path }))
            };
          }
        }
        saveTMDBCache();
        await loadData();
        render();
      }
    } catch(e) {}
  }
}

function render() {
  computeAdjustedScores();
  populateGenreFilter();
  populateWatchSourceFilter();
  renderStats();
  if (activeTab === 'rankings') renderRatings();
  else renderWatchlist();
  renderEditSections();
  document.getElementById('sb-count').textContent = ratings.filter(r => r.rating !== 'DNF').length + ' films rated';
  // Undo bar
  const undoEl = document.getElementById('undo-container');
  if (undoEl) {
    if (lastDeleted) {
      undoEl.innerHTML = `<div class="undo-bar">Deleted \u201c${escHtml(lastDeleted.data.title)}\u201d <button class="mac-btn mac-btn-sm" onclick="undoDelete()">Undo</button></div>`;
    } else {
      undoEl.innerHTML = '';
    }
  }
}

function renderStats() {
  const nr = ratings.filter(r => r.rating !== 'DNF');
  const avg = nr.length ? (nr.reduce((s,r) => s + r.rating, 0) / nr.length).toFixed(2) : '0';
  const tens = nr.filter(r => r.rating === 10).length;
  document.getElementById('s-total').textContent = nr.length;
  document.getElementById('s-avg').textContent = avg;
  document.getElementById('s-tens').textContent = tens;
  document.getElementById('s-watch').textContent = watchlist.length;
}

function renderRatings() {
  const filter = document.getElementById('filter-input').value.toLowerCase();
  const sortBy = document.getElementById('sort-select')?.value || 'date';
  const genreFilter = document.getElementById('genre-filter')?.value || '';
  const tagFilter = document.getElementById('tag-filter')?.value || '';

  let filtered = ratings.filter(r => {
    if (!r.title.toLowerCase().includes(filter)) return false;
    if (genreFilter) {
      const tmdb = getTMDBInfo(r.tmdb_id);
      if (!tmdb || !tmdb.genres || !tmdb.genres.includes(genreFilter)) return false;
    }
    if (tagFilter === 'dnf') {
      if (r.rating !== 'DNF') return false;
    } else if (tagFilter) {
      if (!r.tags || !r.tags.includes(tagFilter)) return false;
    }
    return true;
  });

  if (sortBy === 'score-desc') {
    filtered.sort((a, b) => {
      if (a.rating === 'DNF') return 1;
      if (b.rating === 'DNF') return -1;
      return b.rating - a.rating;
    });
  } else if (sortBy === 'score-asc') {
    filtered.sort((a, b) => {
      if (a.rating === 'DNF') return 1;
      if (b.rating === 'DNF') return -1;
      return a.rating - b.rating;
    });
  } else if (sortBy === 'title') {
    filtered.sort((a, b) => a.title.localeCompare(b.title));
  }

  let html = '';
  if (sortBy === 'date') {
    const years = {};
    filtered.forEach(r => {
      const p = parseDate(r.date);
      if (!years[p.year]) years[p.year] = {};
      if (!years[p.year][p.month]) years[p.year][p.month] = [];
      years[p.year][p.month].push(r);
    });
    Object.keys(years).sort((a,b) => b - a).forEach(year => {
      const ym = Object.values(years[year]).flat();
      const yc = ym.filter(r => r.rating !== 'DNF').length;
      html += `<div class="year-header"><span>//${year}</span><span class="year-count">(${yc})</span></div>`;
      Object.keys(years[year]).sort((a,b) => b - a).forEach(month => {
        const movies = years[year][month];
        const mc = movies.filter(r => r.rating !== 'DNF').length;
        html += `<div class="month-header">${MONTHS[month-1]} <span class="month-count">(${mc})</span></div>`;
        movies.forEach(m => {
          html += editingId === m.id ? renderEditRow(m) : renderMovieRow(m);
        });
      });
    });
  } else {
    filtered.forEach(m => {
      html += editingId === m.id ? renderEditRow(m) : renderMovieRow(m);
    });
  }
  document.getElementById('ratings-list').innerHTML = html;
}

function renderMovieRow(m) {
  const tags = (m.tags || []).map(t => {
    const cls = {t:'tag-theater',f:'tag-festival',o:'tag-opening',r:'tag-prelist'}[t] || '';
    const label = {t:'T',f:'F',o:'OD',r:'PL'}[t] || t;
    return `<span class="tag ${cls}">${label}</span>`;
  }).join('');

  const actions = mode === 'edit' ? `
    <div class="movie-actions">
      <button class="mac-btn mac-btn-sm" onclick="event.stopPropagation();logRewatch(${m.id})" title="Log rewatch" style="min-width:auto;padding:1px 5px;font-size:10px">Re</button>
      <button class="mac-btn mac-btn-sm" onclick="event.stopPropagation();startEdit(${m.id})" title="Edit" style="min-width:auto;padding:1px 5px;font-size:10px">Edit</button>
      <button class="mac-btn mac-btn-sm" onclick="event.stopPropagation();deleteRating(${m.id})" title="Delete" style="min-width:auto;padding:1px 5px;font-size:10px">&times;</button>
    </div>` : '';

  let posterHtml = '<div class="movie-poster-ph">?</div>';
  let infoHtml = '';
  const tmdb = getTMDBInfo(m.tmdb_id);
  if (tmdb) {
    if (tmdb.poster_path) {
      posterHtml = `<img class="movie-poster" src="${getPosterUrl(tmdb.poster_path)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
    }
    const yr = tmdb.release_date ? tmdb.release_date.substring(0, 4) : '';
    const genres = tmdb.genres ? tmdb.genres.join(', ') : '';
    const parts = [yr, genres].filter(Boolean);
    if (parts.length) infoHtml = `<div class="movie-info">${escHtml(parts.join(' \u00B7 '))}</div>`;
  }

  const rwCount = rewatchCounts[m.id] || 0;
  const rwBadge = rwCount > 0 ? `<span class="rewatch-badge" title="${rwCount + 1} total viewings">\u00D7${rwCount + 1}</span>` : '';

  const clickHandler = m.tmdb_id ? `onclick="showMovieDetail(${m.tmdb_id})"` : '';
  return `<div class="movie-row" ${clickHandler}>
    ${posterHtml}
    <span class="movie-date">${escHtml(m.date)}</span>
    <div class="movie-title-wrap">
      <div class="movie-title">${escHtml(m.title)}${rwBadge}</div>
      ${infoHtml}
    </div>
    <span class="movie-tags">${tags}</span>
    <span class="movie-rating ${ratingClass(m.rating)}">${ratingDisplay(m.rating)}${adjustedScores[m.id] !== undefined ? `<span class="adjusted-score">${adjustedScores[m.id].toFixed(1)}</span>` : ''}</span>
    ${actions}
  </div>`;
}

function renderEditRow(m) {
  const tc = ['t','f','o','r'].map(t => {
    const l = {t:'Theater',f:'Festival',o:'Opening Day',r:'Pre-List'}[t];
    const ck = (m.tags || []).includes(t) ? 'checked' : '';
    return `<label><input type="checkbox" data-tag="${t}" ${ck}> ${l}</label>`;
  }).join('');

  return `<div class="edit-inline" style="position:relative">
    <input class="mac-input date-input" id="edit-date" value="${escHtml(m.date)}">
    <input class="mac-input title-input" id="edit-title" value="${escHtml(m.title)}" oninput="onEditTitleSearch(this.value)">
    <input class="mac-input rating-input" id="edit-rating" value="${m.rating === 'DNF' ? 'DNF' : m.rating}">
    <input type="hidden" id="edit-tmdb-id" value="${m.tmdb_id || ''}">
    <div class="form-tags">${tc}</div>
    <button class="mac-btn mac-btn-sm" onclick="saveEdit(${m.id})">Save</button>
    <button class="mac-btn mac-btn-sm" onclick="clearEditTmdb()">Not on TMDB</button>
    <button class="mac-btn mac-btn-sm" onclick="cancelEdit()">Cancel</button>
    <div id="edit-tmdb-dropdown" class="tmdb-dropdown" style="display:none"></div>
  </div>`;
}

function renderWatchlist() {
  const filter = document.getElementById('filter-watch').value.toLowerCase();
  const sourceFilter = document.getElementById('watch-source-filter')?.value || '';
  let filtered = watchlist.filter(w => w.title.toLowerCase().includes(filter));
  if (sourceFilter === 'mine') {
    filtered = filtered.filter(w => !w.suggested_by);
  } else if (sourceFilter === '__suggestions__') {
    filtered = filtered.filter(w => w.suggested_by);
  } else if (sourceFilter) {
    filtered = filtered.filter(w => w.suggested_by === sourceFilter);
  }
  let html = '';
  filtered.forEach((w, i) => {
    const actions = mode === 'edit' ? `
      <div class="movie-actions">
        <button class="mac-btn mac-btn-sm" onclick="event.stopPropagation();watchedMovie(${w.id})" title="Mark watched" style="min-width:auto;padding:1px 5px;font-size:10px">Watched</button>
        <button class="mac-btn mac-btn-sm" onclick="event.stopPropagation();deleteWatch(${w.id})" title="Remove" style="min-width:auto;padding:1px 5px;font-size:10px">&times;</button>
      </div>` : '';
    let posterHtml = '<div class="movie-poster-ph">?</div>';
    const tmdb = getTMDBInfo(w.tmdb_id);
    if (tmdb && tmdb.poster_path) {
      posterHtml = `<img class="movie-poster" src="${getPosterUrl(tmdb.poster_path)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
    }
    let providersHtml = '';
    if (tmdb && tmdb.providers) {
      const { flatrate, rent, buy } = tmdb.providers;
      const renderGroup = (list, label) => {
        if (!list || !list.length) return '';
        const items = list.slice(0, 3).map(p =>
          p.logo
            ? `<img class="watch-provider-logo" src="${TMDB_IMG}/w45${p.logo}" alt="${escHtml(p.name)}" title="${escHtml(p.name)}">`
            : `<span class="watch-provider-name">${escHtml(p.name)}</span>`
        ).join('');
        return `<span class="watch-provider-group"><span class="watch-provider-label">${label}</span>${items}</span>`;
      };
      const groups = [renderGroup(flatrate, 'Stream'), renderGroup(rent, 'Rent'), renderGroup(buy, 'Buy')].filter(Boolean).join('');
      if (groups) providersHtml = `<div class="watch-providers">${groups}</div>`;
    }
    const clickHandler = w.tmdb_id ? `onclick="showMovieDetail(${w.tmdb_id})"` : '';
    html += `<div class="watch-item" ${clickHandler}>
      ${posterHtml}
      <span class="watch-num">${i + 1}.</span>
      <div class="watch-title-wrap">
        <span class="watch-title">${escHtml(w.title)}</span>
        ${w.suggested_by ? `<div class="watch-suggested">${mode === 'edit' ? `Suggested by ${escHtml(w.suggested_by)}${w.reason ? ` &mdash; &ldquo;${escHtml(w.reason)}&rdquo;` : ''}` : 'Suggested'}</div>` : ''}
        ${providersHtml}
      </div>
      ${actions}
    </div>`;
  });
  document.getElementById('watchlist-list').innerHTML = html;
}

function renderEditSections() {
  const ars = document.getElementById('add-rating-section');
  const aws = document.getElementById('add-watch-section');
  const es = document.getElementById('export-section');
  const ss = document.getElementById('suggest-section');

  if (mode !== 'edit') {
    if (ars) ars.innerHTML = '';
    if (aws) aws.innerHTML = '';
    if (es) es.innerHTML = '';
    if (ss) ss.style.display = '';
    return;
  }
  if (ss) ss.style.display = 'none';

  if (activeTab === 'rankings' && ars) {
    ars.innerHTML = `
      <div class="add-form">
        <span class="add-form-label">Add Movie</span>
        <div class="form-row">
          <label>Date:</label>
          <input class="mac-input date-input" id="new-date" placeholder="MM/DD/YY" value="${todayStr()}">
          <label>Title:</label>
          <input class="mac-input title-input" id="new-title" placeholder="Search TMDB..." oninput="onTitleSearch(this.value)">
          <label>Rating:</label>
          <input class="mac-input rating-input" id="new-rating" placeholder="0-10">
          <input type="hidden" id="new-tmdb-id">
        </div>
        <div id="tmdb-dropdown" class="tmdb-dropdown" style="display:none"></div>
        <div class="form-tags">
          <label><input type="checkbox" id="new-tag-t"> Theater</label>
          <label><input type="checkbox" id="new-tag-f"> Festival</label>
          <label><input type="checkbox" id="new-tag-o"> Opening Day</label>
          <label><input type="checkbox" id="new-tag-r"> Pre-List</label>
        </div>
        <button class="mac-btn" onclick="addRating()">Add</button>
      </div>`;
  } else if (activeTab === 'watchlist' && aws) {
    aws.innerHTML = `
      <div class="add-form">
        <span class="add-form-label">Add to Watchlist</span>
        <div class="form-row">
          <label>Title:</label>
          <input class="mac-input title-input" id="new-watch-title" placeholder="Movie title">
          <button class="mac-btn" onclick="addWatch()">Add</button>
        </div>
      </div>`;
  }

  if (es) {
    es.innerHTML = `
      <div class="export-section">
        <button class="mac-btn" onclick="exportData()">Export Data</button>
      </div>`;
  }
}

// === TAB SWITCHING ===
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.mac-tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('tab-rankings').style.display = tab === 'rankings' ? '' : 'none';
  document.getElementById('tab-watchlist').style.display = tab === 'watchlist' ? '' : 'none';
  editingId = null;
  render();
}

// === EDIT ACTIONS ===
async function addRating() {
  const date = document.getElementById('new-date').value.trim();
  const title = document.getElementById('new-title').value.trim();
  const rv = document.getElementById('new-rating').value.trim();
  const tmdbIdEl = document.getElementById('new-tmdb-id');
  const tmdbId = tmdbIdEl ? parseInt(tmdbIdEl.value) || null : null;
  if (!date || !title) return;

  const rating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  if (rating !== 'DNF' && isNaN(rating)) return;

  const tags = [];
  if (document.getElementById('new-tag-t').checked) tags.push('t');
  if (document.getElementById('new-tag-f').checked) tags.push('f');
  if (document.getElementById('new-tag-o').checked) tags.push('o');
  if (document.getElementById('new-tag-r').checked) tags.push('r');

  await db.from('ratings').insert({
    date,
    title,
    rating: String(rating),
    tags,
    tmdb_id: tmdbId,
    sort_order: computeSortOrder(date)
  });
  await loadData();
  render();

  document.getElementById('new-date').value = '';
  document.getElementById('new-title').value = '';
  document.getElementById('new-rating').value = '';
  if (tmdbIdEl) tmdbIdEl.value = '';
  ['new-tag-t','new-tag-f','new-tag-o','new-tag-r'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.checked = false;
  });
}

async function logRewatch(ratingId) {
  await db.from('rewatches').insert({ rating_id: ratingId });
  rewatchCounts[ratingId] = (rewatchCounts[ratingId] || 0) + 1;
  render();
  const movie = ratings.find(r => r.id === ratingId);
  if (movie) alert(`Logged rewatch of "${movie.title}" (\u00D7${rewatchCounts[ratingId] + 1} total)`);
}

async function deleteRewatch(rwId, tmdbId) {
  await db.from('rewatches').delete().eq('id', rwId);
  const ratingEntry = ratings.find(r => r.tmdb_id === tmdbId);
  if (ratingEntry && rewatchCounts[ratingEntry.id]) {
    rewatchCounts[ratingEntry.id]--;
    if (rewatchCounts[ratingEntry.id] <= 0) delete rewatchCounts[ratingEntry.id];
  }
  render();
  showMovieDetail(tmdbId);
}

async function deleteRating(id) {
  const movie = ratings.find(r => r.id === id);
  if (!movie || !confirm(`Delete "${movie.title}"?`)) return;
  await db.from('ratings').delete().eq('id', id);
  ratings = ratings.filter(r => r.id !== id);
  showUndo('rating', movie);
  render();
}

function startEdit(id) { editingId = id; render(); }
function cancelEdit() { editingId = null; render(); }

async function saveEdit(id) {
  const m = ratings.find(r => r.id === id);
  if (!m) return;
  const newDate = document.getElementById('edit-date').value.trim();
  const newTitle = document.getElementById('edit-title').value.trim();
  const rv = document.getElementById('edit-rating').value.trim();
  const newRating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  const tmdbIdVal = document.getElementById('edit-tmdb-id');
  const newTmdbId = tmdbIdVal ? (parseInt(tmdbIdVal.value) || null) : m.tmdb_id;
  const newTags = [];
  document.querySelectorAll('.edit-inline [data-tag]').forEach(cb => {
    if (cb.checked) newTags.push(cb.dataset.tag);
  });
  await db.from('ratings').update({
    date: newDate,
    title: newTitle,
    rating: String(newRating),
    tags: newTags,
    tmdb_id: newTmdbId,
    sort_order: computeSortOrder(newDate)
  }).eq('id', id);
  m.date = newDate;
  m.title = newTitle;
  m.rating = newRating;
  m.tags = newTags;
  m.tmdb_id = newTmdbId;
  editingId = null;
  render();
}

async function addWatch() {
  const title = document.getElementById('new-watch-title').value.trim();
  if (!title) return;
  if (ratings.some(r => r.title.toLowerCase() === title.toLowerCase())) {
    alert(`"${title}" is already in your watched list.`);
    return;
  }
  if (watchlist.some(w => w.title.toLowerCase() === title.toLowerCase())) {
    alert(`"${title}" is already on the watchlist!`);
    return;
  }
  const { data: inserted } = await db.from('watchlist').insert({ title }).select().single();
  await loadData();
  render();
  document.getElementById('new-watch-title').value = '';
  // Auto-match TMDB immediately
  if (inserted) {
    try {
      const searchData = await tmdbSearch(title, null);
      if (searchData.results && searchData.results.length > 0) {
        const best = searchData.results[0];
        await db.from('watchlist').update({ tmdb_id: best.id }).eq('id', inserted.id);
        tmdbCache[best.id] = tmdbCacheFromResult(best);
        const detailResp = await fetch(`${TMDB_BASE}/movie/${best.id}?api_key=${TMDB_KEY}&append_to_response=watch/providers`);
        if (detailResp.ok) {
          const detail = await detailResp.json();
          const usP = detail['watch/providers']?.results?.US;
          if (usP) {
            tmdbCache[best.id].providers = {
              flatrate: (usP.flatrate || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
              rent: (usP.rent || []).map(p => ({ name: p.provider_name, logo: p.logo_path })),
              buy: (usP.buy || []).map(p => ({ name: p.provider_name, logo: p.logo_path }))
            };
          }
        }
        saveTMDBCache();
        await loadData();
        render();
      }
    } catch(e) { /* TMDB match failed, will retry on next page load */ }
  }
}

async function deleteWatch(id) {
  const item = watchlist.find(w => w.id === id);
  if (!item || !confirm(`Remove "${item.title}" from watchlist?`)) return;
  await db.from('watchlist').delete().eq('id', id);
  watchlist = watchlist.filter(w => w.id !== id);
  showUndo('watch', item);
  render();
}

let watchedItemId = null;
function watchedMovie(id) {
  const w = watchlist.find(x => x.id === id);
  if (!w) return;
  watchedItemId = id;
  document.getElementById('watched-modal-title').textContent = w.title;
  document.getElementById('watched-modal-body').innerHTML = `
    <div class="form-row">
      <label>Date:</label>
      <input class="mac-input date-input" id="watched-date" value="${todayStr()}">
    </div>
    <div class="form-row">
      <label>Rating:</label>
      <input class="mac-input rating-input" id="watched-rating" placeholder="0-10 or DNF">
    </div>
    <div class="form-tags">
      <label><input type="checkbox" id="watched-tag-t"> Theater</label>
      <label><input type="checkbox" id="watched-tag-f"> Festival</label>
      <label><input type="checkbox" id="watched-tag-o"> Opening Day</label>
      <label><input type="checkbox" id="watched-tag-r"> Pre-List</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="mac-btn" onclick="closeWatchedModal()">Cancel</button>
      <button class="mac-btn mac-btn-primary" onclick="confirmWatched()">Save</button>
    </div>`;
  document.getElementById('watched-modal').style.display = 'flex';
}

async function confirmWatched() {
  const w = watchlist.find(x => x.id === watchedItemId);
  if (!w) return;
  const date = document.getElementById('watched-date').value.trim();
  const rv = document.getElementById('watched-rating').value.trim();
  if (!date || !rv) return;
  const rating = rv.toUpperCase() === 'DNF' ? 'DNF' : parseFloat(rv);
  if (rating !== 'DNF' && isNaN(rating)) return;
  const tags = [];
  if (document.getElementById('watched-tag-t').checked) tags.push('t');
  if (document.getElementById('watched-tag-f').checked) tags.push('f');
  if (document.getElementById('watched-tag-o').checked) tags.push('o');
  if (document.getElementById('watched-tag-r').checked) tags.push('r');
  await db.from('watchlist').delete().eq('id', watchedItemId);
  await db.from('ratings').insert({
    date, title: w.title, rating: String(rating),
    tags, tmdb_id: w.tmdb_id,
    sort_order: computeSortOrder(date)
  });
  closeWatchedModal();
  await loadData();
  render();
}

function closeWatchedModal() {
  document.getElementById('watched-modal').style.display = 'none';
  watchedItemId = null;
}

// === EXPORT / RESET ===
function exportData() {
  const data = JSON.stringify({ ratings, watchlist }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'films_data.json'; a.click();
  URL.revokeObjectURL(url);
}


// === MENU BAR CLOCK ===
function updateClock() {
  const now = new Date();
  const el = document.getElementById('menu-clock');
  if (el) {
    el.textContent = now.toLocaleTimeString('en-US', {
      hour: 'numeric', minute: '2-digit', hour12: true
    });
  }
}
updateClock();
setInterval(updateClock, 30000);

// === BEFOREUNLOAD ===
window.addEventListener('beforeunload', () => {
  localStorage.setItem(TMDB_CACHE_KEY, JSON.stringify(tmdbCache));
});

// === WINDOW DRAG & RESIZE (Desktop Only) ===
(function() {
  const app = document.getElementById('app');
  const titlebar = app.querySelector('.window-titlebar');
  const resizeHandle = document.getElementById('resize-handle');

  let isDragging = false;
  let isResizing = false;
  let hasDragged = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  let resizeStartX = 0;
  let resizeStartY = 0;
  let resizeStartW = 0;
  let resizeStartH = 0;

  const MIN_WIDTH = 360;
  const MIN_HEIGHT = 300;

  function isMobile() { return window.innerWidth <= 640; }

  function convertToAbsolute() {
    if (hasDragged) return;
    const rect = app.getBoundingClientRect();
    app.style.top = rect.top + 'px';
    app.style.left = rect.left + 'px';
    app.style.transform = 'none';
    app.style.width = rect.width + 'px';
    hasDragged = true;
  }

  function clampPosition(x, y, w, h) {
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    x = Math.max(-w + 40, Math.min(x, vw - 40));
    y = Math.max(0, Math.min(y, vh - 40));
    return { x, y };
  }

  titlebar.addEventListener('mousedown', function(e) {
    if (isMobile()) return;
    if (e.target.closest('.close-box') || e.target.closest('.zoom-box')) return;
    e.preventDefault();
    convertToAbsolute();
    const rect = app.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    isDragging = true;
    app.classList.add('is-dragging');
  });

  resizeHandle.addEventListener('mousedown', function(e) {
    if (isMobile()) return;
    e.preventDefault();
    e.stopPropagation();
    convertToAbsolute();
    const rect = app.getBoundingClientRect();
    resizeStartX = e.clientX;
    resizeStartY = e.clientY;
    resizeStartW = rect.width;
    resizeStartH = rect.height;
    isResizing = true;
    app.classList.add('is-dragging');
  });

  document.addEventListener('mousemove', function(e) {
    if (isDragging) {
      const newX = e.clientX - dragOffsetX;
      const newY = e.clientY - dragOffsetY;
      const rect = app.getBoundingClientRect();
      const c = clampPosition(newX, newY, rect.width, rect.height);
      app.style.left = c.x + 'px';
      app.style.top = c.y + 'px';
    }
    if (isResizing) {
      const dx = e.clientX - resizeStartX;
      const dy = e.clientY - resizeStartY;
      let newW = Math.max(MIN_WIDTH, resizeStartW + dx);
      let newH = Math.max(MIN_HEIGHT, resizeStartH + dy);
      const left = parseInt(app.style.left) || 0;
      const top = parseInt(app.style.top) || 0;
      newW = Math.min(newW, window.innerWidth - left);
      newH = Math.min(newH, window.innerHeight - top);
      app.style.width = newW + 'px';
      app.style.maxHeight = newH + 'px';
    }
  });

  document.addEventListener('mouseup', function() {
    if (isDragging || isResizing) {
      isDragging = false;
      isResizing = false;
      app.classList.remove('is-dragging');
    }
  });

  window.addEventListener('resize', function() {
    if (isMobile() && hasDragged) {
      app.style.top = '';
      app.style.left = '';
      app.style.transform = '';
      app.style.width = '';
      app.style.maxHeight = '';
      hasDragged = false;
    } else if (hasDragged) {
      const rect = app.getBoundingClientRect();
      const c = clampPosition(rect.left, rect.top, rect.width, rect.height);
      app.style.left = c.x + 'px';
      app.style.top = c.y + 'px';
    }
  });
})();

// === INIT ===
document.getElementById('pwd-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') attemptLogin();
});

const savedMode = sessionStorage.getItem(SESSION_KEY);
if (savedMode === 'view' || savedMode === 'edit') {
  mode = savedMode;
  showApp();
}
</script>

</body>
</html>
